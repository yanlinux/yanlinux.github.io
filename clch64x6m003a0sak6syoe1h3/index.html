<!DOCTYPE HTML>
<html lang="zh-CN">
    <!-- shw2018 洪卫  modify 2019.08.15-->



<head><meta name="generator" content="Hexo 3.9.0">
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
    <meta name="keywords" content="第八周作业, Linux SRE Python R">
    <meta name="baidu-site-verification" content="fmlEuI34ir">
    <meta name="google-site-verification" content="KeoTn_OFy4ndJwXNmm2gMeQfPhd7alqE9vQDwI32KCY">
    <meta name="description" content="1 redis搭建哨兵原理和集群实现。1.1 哨兵原理Sentinel是一个分布式系统,即需要在多个节点上各自同时运行一个sentinel进程，Sentienl 进程通过流言协议(gossip protocols)来接收关于Master是否">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>第八周作业 | 焱黎的博客</title>
    <link rel="icon" type="image/jpeg" href="https://yanlinuxblog.oss-cn-hangzhou.aliyuncs.com/img/image_20220801100631.jpg">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.bootcss.com/materialize/1.0.0/css/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.bootcss.com/aos/3.0.0-beta.6/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/1.7.2/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    
    <style type="text/css">
        
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>
    
    <script>
        var _hmt = _hmt || [];
        (function () {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?46e79e71af0709a5b9106bf20cecc493";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>

    
    
        <script>
            (function(){
                var bp = document.createElement('script');
                var curProtocol = window.location.protocol.split(':')[0];
                if (curProtocol === 'https') {
                    bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
                }
                else {
                    bp.src = 'http://push.zhanzhang.baidu.com/push.js';
                }
                var s = document.getElementsByTagName("script")[0];
                s.parentNode.insertBefore(bp, s);
            })();
        </script>
    

<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"><!-- hexo-inject:begin --><!-- hexo-inject:end --></head>

    <body>

        <!-- hexo-inject:begin --><!-- hexo-inject:end --><header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="https://yanlinuxblog.oss-cn-hangzhou.aliyuncs.com/img/202207291252776.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">焱黎的博客</span>
                </a>
            </div>
            


<!-- <a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right">
    
    <li class="hide-on-med-and-down">
        <a href="/" class="waves-effect waves-light">
            
            <i class="fa fa-home"></i>
            
            <span>首页</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/tags" class="waves-effect waves-light">
            
            <i class="fa fa-tags"></i>
            
            <span>标签</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories" class="waves-effect waves-light">
            
            <i class="fa fa-bookmark"></i>
            
            <span>分类</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/archives" class="waves-effect waves-light">
            
            <i class="fa fa-archive"></i>
            
            <span>归档</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/AV" class="waves-effect waves-light">
            
            <i class="fa fa-music"></i>
            
            <span>视听</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/galleries" class="waves-effect waves-light">
            
            <i class="fa fa-photo"></i>
            
            <span>相册</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/about" class="waves-effect waves-light">
            
            <i class="fa fa-user-circle-o"></i>
            
            <span>关于我</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/contact" class="waves-effect waves-light">
            
            <i class="fa fa-envelope"></i>
            
            <span>留言板</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/friends" class="waves-effect waves-light">
            
            <i class="fa fa-address-book"></i>
            
            <span>友情链接</span>
        </a>
    </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>
</ul> -->

<!-- 支持二级菜单特性 洪卫 shw2018 modify 2019.09.17  -->
<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right nav-menu">
    
      <li class="hide-on-med-and-down nav-item" >

        
            <a href="/" class="waves-effect waves-light">
              
                <i class="fa fa-home"></i>
              
              <span>首页</span>
            </a>

            
      </li>
    
      <li class="hide-on-med-and-down nav-item" >

        
            <a href="/tags" class="waves-effect waves-light">
              
                <i class="fa fa-tags"></i>
              
              <span>标签</span>
            </a>

            
      </li>
    
      <li class="hide-on-med-and-down nav-item" >

        
            <a href="/categories" class="waves-effect waves-light">
              
                <i class="fa fa-bookmark"></i>
              
              <span>分类</span>
            </a>

            
      </li>
    
      <li class="hide-on-med-and-down nav-item" >

        
            <a href="/archives" class="waves-effect waves-light">
              
                <i class="fa fa-archive"></i>
              
              <span>归档</span>
            </a>

            
      </li>
    
      <li class="hide-on-med-and-down nav-item" >

        
            <a href="/AV" class="waves-effect waves-light">
              
                <i class="fa fa-music"></i>
              
              <span>视听</span>
            </a>

            
      </li>
    
      <li class="hide-on-med-and-down nav-item" >

        
            <a href="/galleries" class="waves-effect waves-light">
              
                <i class="fa fa-photo"></i>
              
              <span>相册</span>
            </a>

            
      </li>
    
      <li class="hide-on-med-and-down nav-item" >

        
            <a href="/about" class="waves-effect waves-light">
              
                <i class="fa fa-user-circle-o"></i>
              
              <span>关于我</span>
            </a>

            
      </li>
    
      <li class="hide-on-med-and-down nav-item" >

        
            <a href="/contact" class="waves-effect waves-light">
              
                <i class="fa fa-envelope"></i>
              
              <span>留言板</span>
            </a>

            
      </li>
    
      <li class="hide-on-med-and-down nav-item" >

        
            <a href="/friends" class="waves-effect waves-light">
              
                <i class="fa fa-address-book"></i>
              
              <span>友情链接</span>
            </a>

            
      </li>
    

    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>

</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="https://yanlinuxblog.oss-cn-hangzhou.aliyuncs.com/img/202207291252776.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">焱黎的博客</div>
        <div class="logo-desc">
            
            Linux | SRE | Python
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li>
            <a href="/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-home"></i>
                
                首页
            </a>
        </li>
        
        <li>
            <a href="/tags" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-tags"></i>
                
                标签
            </a>
        </li>
        
        <li>
            <a href="/categories" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-bookmark"></i>
                
                分类
            </a>
        </li>
        
        <li>
            <a href="/archives" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-archive"></i>
                
                归档
            </a>
        </li>
        
        <li>
            <a href="/AV" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-music"></i>
                
                视听
            </a>
        </li>
        
        <li>
            <a href="/galleries" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-photo"></i>
                
                相册
            </a>
        </li>
        
        <li>
            <a href="/about" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-user-circle-o"></i>
                
                关于我
            </a>
        </li>
        
        <li>
            <a href="/contact" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-envelope"></i>
                
                留言板
            </a>
        </li>
        
        <li>
            <a href="/friends" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-address-book"></i>
                
                友情链接
            </a>
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/yanlinux/yanlinux.github.io" class="waves-effect waves-light" target="_blank">
                <i class="fa fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>

   
   
<!-- 支持二级菜单特性 洪卫 shw2018 modify 2019.09.17  -->
<!-- <ul class="menu-list mobile-menu-list">
    
        <li class="m-nav-item">
                
                    <a href="/" class="waves-effect waves-light">
                        
                        <i class="fa fa-fw fa-home"></i>
                        
                        首页
                    </a>
              
            </li>
        
        <li class="m-nav-item">
                
                    <a href="/tags" class="waves-effect waves-light">
                        
                        <i class="fa fa-fw fa-tags"></i>
                        
                        标签
                    </a>
              
            </li>
        
        <li class="m-nav-item">
                
                    <a href="/categories" class="waves-effect waves-light">
                        
                        <i class="fa fa-fw fa-bookmark"></i>
                        
                        分类
                    </a>
              
            </li>
        
        <li class="m-nav-item">
                
                    <a href="/archives" class="waves-effect waves-light">
                        
                        <i class="fa fa-fw fa-archive"></i>
                        
                        归档
                    </a>
              
            </li>
        
        <li class="m-nav-item">
                
                    <a href="/AV" class="waves-effect waves-light">
                        
                        <i class="fa fa-fw fa-music"></i>
                        
                        视听
                    </a>
              
            </li>
        
        <li class="m-nav-item">
                
                    <a href="/galleries" class="waves-effect waves-light">
                        
                        <i class="fa fa-fw fa-photo"></i>
                        
                        相册
                    </a>
              
            </li>
        
        <li class="m-nav-item">
                
                    <a href="/about" class="waves-effect waves-light">
                        
                        <i class="fa fa-fw fa-user-circle-o"></i>
                        
                        关于我
                    </a>
              
            </li>
        
        <li class="m-nav-item">
                
                    <a href="/contact" class="waves-effect waves-light">
                        
                        <i class="fa fa-fw fa-envelope"></i>
                        
                        留言板
                    </a>
              
            </li>
        
        <li class="m-nav-item">
                
                    <a href="/friends" class="waves-effect waves-light">
                        
                        <i class="fa fa-fw fa-address-book"></i>
                        
                        友情链接
                    </a>
              
            </li>
        

        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/yanlinux/yanlinux.github.io" class="waves-effect waves-light" target="_blank">
                <i class="fa fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul> -->

</div>

        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/yanlinux/yanlinux.github.io" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

        
<script src="/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('https://yanlinuxblog.oss-cn-hangzhou.aliyuncs.com/img/7.jpg')">
    <div class="container">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        第八周作业
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 20px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- shw2018 洪卫  modify 2019.08.15-->
<!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/redis哨兵/" target="_blank">
                                <span class="chip bg-color">redis哨兵</span>
                            </a>
                        
                            <a href="/tags/LVS模型/" target="_blank">
                                <span class="chip bg-color">LVS模型</span>
                            </a>
                        
                            <a href="/tags/LVS负载策略/" target="_blank">
                                <span class="chip bg-color">LVS负载策略</span>
                            </a>
                        
                            <a href="/tags/http通信过程/" target="_blank">
                                <span class="chip bg-color">http通信过程</span>
                            </a>
                        
                            <a href="/tags/网络IO/" target="_blank">
                                <span class="chip bg-color">网络IO</span>
                            </a>
                        
                            <a href="/tags/nginx架构/" target="_blank">
                                <span class="chip bg-color">nginx架构</span>
                            </a>
                        
                            <a href="/tags/编译安装nginx/" target="_blank">
                                <span class="chip bg-color">编译安装nginx</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/作业/" class="post-category" target="_blank">
                                作业
                            </a>
                        
                    </div>
                    
                </div>
            </div>
            
            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2022-11-10
                </div>

                <div class="post-author info-break-policy">
                    <i class="fa fa-user-o fa-fw"></i>作者:&nbsp;&nbsp;
                    
                        焱黎
                    
                </div>

                
                    
                    <div class="info-break-policy">
                        <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                        13.7k
                    </div>
                    

                    
                    <div class="info-break-policy">
                        <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                        70 分
                    </div>
                    
                
                
                
                        <span id="busuanzi_container_site_pv" style='display:none'></span>
                        <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv" ></span>
    
                

            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h2 id="1-redis搭建哨兵原理和集群实现。"><a href="#1-redis搭建哨兵原理和集群实现。" class="headerlink" title="1 redis搭建哨兵原理和集群实现。"></a>1 redis搭建哨兵原理和集群实现。</h2><h3 id="1-1-哨兵原理"><a href="#1-1-哨兵原理" class="headerlink" title="1.1 哨兵原理"></a>1.1 哨兵原理</h3><p>Sentinel是一个分布式系统,即需要在<strong>多个节点上</strong>各自同时运行一个<strong>sentinel进程</strong>，Sentienl 进程通过<strong>流</strong><br><strong>言协议</strong>(gossip protocols)来接收关于Master是否下线状态，并使用<strong>投票协议</strong>(Agreement Protocols)来决定是否执行自动故障转移,并选择合适的Slave作为新的Master</p>
<p>每个Sentinel进程会向其它Sentinel、Master、Slave<strong>定时发送消息</strong>，来确认对方<strong>是否存活</strong>，如果发现某个节点在指定配置时间内<strong>未得到响应</strong>，则会认为此节点已离线，即为<strong>主观宕机</strong><code>Subjective Down</code>，简称为 <code>SDOWN</code></p>
<p>如果哨兵集群中的<strong>多数Sentinel进程认为Master存在SDOWN</strong>，共同利用 <code>is-master-down-by-addr</code>命令互相通知后，则认为<strong>客观宕机</strong><code>Objectively Down</code>， 简称 <code>ODOWN</code></p>
<p>接下来利用<strong>投票算法</strong>，从所有slave节点中，选一台合适的slave将之提升为新Master节点，然后自动修<br>改其它slave相关配置，指向新的master节点,最终<strong>实现故障转移failover</strong></p>
<h3 id="1-2-实现哨兵架构"><a href="#1-2-实现哨兵架构" class="headerlink" title="1.2 实现哨兵架构"></a>1.2 实现哨兵架构</h3><blockquote>
<p>实现一主两从的基于哨兵的高可用Redis架构</p>
</blockquote>
<p><img src="https://yanlinuxblog.oss-cn-hangzhou.aliyuncs.com/img/Snipaste_2022-10-30_16-45-55.png" alt=""></p>
<h4 id="1-2-1-准备主从复制环境"><a href="#1-2-1-准备主从复制环境" class="headerlink" title="1.2.1 准备主从复制环境"></a>1.2.1 准备主从复制环境</h4><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#所有从节点利用编译安装脚本安装redis，</span>
<span class="token punctuation">[</span>20:24:34 root@rocky8 ~<span class="token punctuation">]</span>$ <span class="token function">cat</span> install_redis.sh
<span class="token function">read</span> -p <span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token keyword">echo</span> -e '\033<span class="token punctuation">[</span>1<span class="token punctuation">;</span>32m请输入下载的版本号：\033<span class="token punctuation">[</span>0m'<span class="token variable">)</span></span>"</span> NUM
<span class="token function">read</span> -p <span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token keyword">echo</span> -e '\033<span class="token punctuation">[</span>1<span class="token punctuation">;</span>32m请输入设置的密码: \033<span class="token punctuation">[</span>0m'<span class="token variable">)</span></span>"</span> PASSWORD
REDIS_VERSION<span class="token operator">=</span>redis-<span class="token variable">${NUM}</span>
INSTALL_DIR<span class="token operator">=</span>/apps/redis
CPU<span class="token operator">=</span>`lscpu<span class="token operator">|</span><span class="token function">awk</span> <span class="token string">'/^CPU\(s\)/{print <span class="token variable">$2</span>}'</span>`
<span class="token keyword">.</span> /etc/os-release

color <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    RES_COL<span class="token operator">=</span>60
    MOVE_TO_COL<span class="token operator">=</span><span class="token string">"echo -en \\033[<span class="token variable">${RES_COL}</span>G"</span>
    SETCOLOR_SUCCESS<span class="token operator">=</span><span class="token string">"echo -en \\033[1;32m"</span>
    SETCOLOR_FAILURE<span class="token operator">=</span><span class="token string">"echo -en \\033[1;31m"</span>
    SETCOLOR_WARNING<span class="token operator">=</span><span class="token string">"echo -en \\033[1;33m"</span>
    SETCOLOR_NORMAL<span class="token operator">=</span><span class="token string">"echo -en \E[0m"</span>
    <span class="token keyword">echo</span> -n <span class="token string">"<span class="token variable">$1</span>"</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$MOVE_TO_COL</span>
    <span class="token keyword">echo</span> -n <span class="token string">"["</span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$2</span> <span class="token operator">=</span> <span class="token string">"success"</span> -o <span class="token variable">$2</span> <span class="token operator">=</span> <span class="token string">"0"</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span><span class="token keyword">then</span>
        <span class="token variable">${SETCOLOR_SUCCESS}</span>
        <span class="token keyword">echo</span> -n $<span class="token string">"  OK  "</span>    
    <span class="token keyword">elif</span> <span class="token punctuation">[</span> <span class="token variable">$2</span> <span class="token operator">=</span> <span class="token string">"failure"</span> -o <span class="token variable">$2</span> <span class="token operator">=</span> <span class="token string">"1"</span>  <span class="token punctuation">]</span> <span class="token punctuation">;</span><span class="token keyword">then</span> 
        <span class="token variable">${SETCOLOR_FAILURE}</span>
        <span class="token keyword">echo</span> -n $<span class="token string">"FAILED"</span>
    <span class="token keyword">else</span>
        <span class="token variable">${SETCOLOR_WARNING}</span>
        <span class="token keyword">echo</span> -n $<span class="token string">"WARNING"</span>
    <span class="token keyword">fi</span>
    <span class="token variable">${SETCOLOR_NORMAL}</span>
    <span class="token keyword">echo</span> -n <span class="token string">"]"</span>
    <span class="token keyword">echo</span> 
<span class="token punctuation">}</span>

prepare<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$ID</span> <span class="token operator">=</span> <span class="token string">"centos"</span> -o <span class="token variable">$ID</span> <span class="token operator">=</span> <span class="token string">"rocky"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span>
        yum -y <span class="token function">install</span> gcc <span class="token function">make</span> jemalloc-devel systemd-devel
    <span class="token keyword">else</span>
        apt update
        apt -y <span class="token function">install</span> gcc <span class="token function">make</span> libjemalloc-dev libsystemd-dev
    <span class="token keyword">fi</span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$?</span> -eq 0 <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span>
        color <span class="token string">"依赖包安装成功"</span> 0
    <span class="token keyword">else</span>
        color <span class="token string">"依赖包安装失败，请检查网络配置"</span> 1
    <span class="token keyword">fi</span>
<span class="token punctuation">}</span>

install<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">#下载源码</span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> -f <span class="token variable">${REDIS_VERSION}</span>.tar.gz <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span>
        <span class="token function">wget</span> http://download.redis.io/releases/<span class="token variable">${REDIS_VERSION}</span>.tar.gz <span class="token operator">||</span> <span class="token punctuation">{</span> color <span class="token string">"Redis 源码下载失败"</span> 1 <span class="token punctuation">;</span> <span class="token keyword">exit</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">fi</span>
    <span class="token function">tar</span> xf <span class="token variable">${REDIS_VERSION}</span>.tar.gz -C /usr/local/src
    <span class="token function">cd</span> /usr/local/src/<span class="token variable">${REDIS_VERSION}</span>

    <span class="token comment" spellcheck="true">#编译安装</span>
    <span class="token function">make</span> -j <span class="token variable">$CPU</span> USE_SYSTEMD<span class="token operator">=</span>yes PREFIX<span class="token operator">=</span><span class="token variable">${INSTALL_DIR}</span> <span class="token function">install</span> <span class="token operator">&amp;&amp;</span> color <span class="token string">"Redis 编译安装完成"</span> 0 <span class="token operator">||</span> <span class="token punctuation">{</span> color <span class="token string">"Redis 编译安装失败"</span> 1 <span class="token punctuation">;</span> <span class="token keyword">exit</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">#配置环境变量</span>
    <span class="token function">ln</span> -s <span class="token variable">${INSTALL_DIR}</span>/bin/redis-* /usr/bin/

    <span class="token comment" spellcheck="true">#准备相关目录和配置文件</span>
    <span class="token function">mkdir</span> <span class="token variable">${INSTALL_DIR}</span>/<span class="token punctuation">{</span>etc,log,data,run<span class="token punctuation">}</span>
    <span class="token function">cp</span> redis.conf <span class="token variable">${INSTALL_DIR}</span>/etc/

    <span class="token comment" spellcheck="true">#修改配置文件</span>
    <span class="token function">sed</span> -i -e <span class="token string">'s/bind 127.0.0.1/bind 0.0.0.0/'</span>  -e <span class="token string">"/# requirepass/a requirepass <span class="token variable">$PASSWORD</span>"</span>  -e <span class="token string">"/^dir .*/c dir <span class="token variable">${INSTALL_DIR}</span>/data/"</span>  -e <span class="token string">"/logfile .*/c logfile <span class="token variable">${INSTALL_DIR}</span>/log/redis-6379.log"</span>  -e  <span class="token string">"/^pidfile .*/c  pidfile <span class="token variable">${INSTALL_DIR}</span>/run/redis_6379.pid"</span> <span class="token variable">${INSTALL_DIR}</span>/etc/redis.conf

    <span class="token keyword">if</span> <span class="token function">id</span> redis <span class="token operator">&amp;</span><span class="token operator">></span> /dev/null <span class="token punctuation">;</span><span class="token keyword">then</span>
        color <span class="token string">"Redis 用户已存在"</span> 1
    <span class="token keyword">else</span>
        <span class="token function">useradd</span> -r -s /sbin/nologin redis
        color <span class="token string">"Redis 用户创建成功"</span> 0
    <span class="token keyword">fi</span>

    <span class="token comment" spellcheck="true">#修改安装路径权限</span>
    <span class="token function">chown</span> -R redis.redis <span class="token variable">${INSTALL_DIR}</span>

    <span class="token comment" spellcheck="true">#消除启动时的Warning提示信息</span>
    <span class="token function">cat</span> <span class="token operator">>></span> /etc/sysctl.conf <span class="token operator">&lt;&lt;</span><span class="token string">EOF
net.core.somaxconn = 1024
vm.overcommit_memory = 1
EOF</span>
    sysctl -p
    <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$ID</span> <span class="token operator">=</span> <span class="token string">"centos"</span> -o <span class="token variable">$ID</span> <span class="token operator">=</span> <span class="token string">"rocky"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span>
        <span class="token keyword">echo</span> <span class="token string">'echo never > /sys/kernel/mm/transparent_hugepage/enabled'</span> <span class="token operator">>></span> /etc/rc.d/rc.local
        <span class="token function">chmod</span> +x /etc/rc.d/rc.local
        /etc/rc.d/rc.local
    <span class="token keyword">else</span>
        <span class="token keyword">echo</span> -e <span class="token string">'#!/bin/bash\necho never > /sys/kernel/mm/transparent_hugepage/enabled'</span> <span class="token operator">>></span> /etc/rc.local
        <span class="token function">chmod</span> +x /etc/rc.local
        /etc/rc.local
    <span class="token keyword">fi</span>

    <span class="token comment" spellcheck="true">#创建redis服务service文件</span>
    <span class="token function">cat</span> <span class="token operator">></span> /lib/systemd/system/redis.service <span class="token operator">&lt;&lt;</span><span class="token string">EOF
[Unit]
Description=Redis persistent key-value database
After=network.target

[Service]
ExecStart=<span class="token variable">${INSTALL_DIR}</span>/bin/redis-server <span class="token variable">${INSTALL_DIR}</span>/etc/redis.conf --supervised systemd
ExecStop=/bin/kill -s QUIT \<span class="token variable">$MAINPID</span>
Type=notify
User=redis
Group=redis
RuntimeDirectory=redis
RuntimeDirectoryMode=0755
LimitNOFILE=1000000

[Install]
WantedBy=multi-user.target
EOF</span>

    <span class="token comment" spellcheck="true">#启动service</span>
    systemctl daemon-reload
    systemctl <span class="token function">enable</span> --now redis <span class="token operator">&amp;</span><span class="token operator">></span> /dev/null
    <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$?</span> -eq 0 <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span>
        color <span class="token string">"Redis服务启动成功,Redis信息如下:"</span> 0
    <span class="token keyword">else</span>
        color <span class="token string">"Redis启动失败"</span> 1
        <span class="token keyword">exit</span>
    <span class="token keyword">fi</span>
    <span class="token function">sleep</span> 2
    redis-cli -a <span class="token variable">${PASSWORD}</span> INFO Server 2<span class="token operator">></span> /dev/null
<span class="token punctuation">}</span>

prepare
<span class="token function">install</span>


<span class="token comment" spellcheck="true">#然后再redis.conf配置文件中添加以下两行信息，实现主从复制，所有节点的密码一样</span>
replicaof 10.0.0.8 6379
masterauth lgq123456
<span class="token comment" spellcheck="true">#然后重启两个从节点的redis服务</span>

<span class="token comment" spellcheck="true">#在主节点配置文件中添加下面一行信息</span>
masterauth lgq123456

<span class="token comment" spellcheck="true">#在主节点查看状态</span>
127.0.0.1:6379<span class="token operator">></span> INFO replication
<span class="token comment" spellcheck="true"># Replication</span>
role:master
connected_slaves:2
min_slaves_good_slaves:2
slave0:ip<span class="token operator">=</span>10.0.0.18,port<span class="token operator">=</span>6379,state<span class="token operator">=</span>online,offset<span class="token operator">=</span>868,lag<span class="token operator">=</span>1
slave1:ip<span class="token operator">=</span>10.0.0.28,port<span class="token operator">=</span>6379,state<span class="token operator">=</span>online,offset<span class="token operator">=</span>868,lag<span class="token operator">=</span>1
master_failover_state:no-failover
master_replid:2b34ad02ae4648196573139f495053803bdb972e
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:882
second_repl_offset:-1
repl_backlog_active:1
repl_backlog_size:1048576
repl_backlog_first_byte_offset:1
repl_backlog_histlen:882<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="1-2-2-在所有主从节点上修改范例配置文件"><a href="#1-2-2-在所有主从节点上修改范例配置文件" class="headerlink" title="1.2.2 在所有主从节点上修改范例配置文件"></a>1.2.2 在所有主从节点上修改范例配置文件</h4><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#如果是编译安装，在源码目录有sentinel.conf，复制到安装目录即可，</span>
<span class="token comment" spellcheck="true">#如:/apps/redis/etc/sentinel.conf</span>
<span class="token punctuation">[</span>11:01:09 root@rocky ~<span class="token punctuation">]</span>$ <span class="token function">ls</span> /usr/local/src/redis-6.2.6/
00-RELEASENOTES  CONTRIBUTING  INSTALL    README.md   runtest-cluster    sentinel.conf  TLS.md
BUGS             COPYING       Makefile   redis.conf  runtest-moduleapi  src            utils
CONDUCT          deps          MANIFESTO  runtest     runtest-sentinel   tests
<span class="token comment" spellcheck="true">#在所有主从节点上将sentinel.conf文件拷贝至安装路径下</span>
<span class="token punctuation">[</span>11:01:44 root@rocky ~<span class="token punctuation">]</span>$ <span class="token function">cp</span> /usr/local/src/redis-6.2.6/sentinel.conf /apps/redis/etc/
<span class="token punctuation">[</span>11:02:47 root@rocky ~<span class="token punctuation">]</span>$ <span class="token function">chown</span> redis.redis /apps/redis/etc/sentinel.conf
<span class="token comment" spellcheck="true">#在所有主从节点上修改范例配置文件</span>
<span class="token comment" spellcheck="true">##主节点修改配置文件</span>
<span class="token punctuation">[</span>11:17:28 root@rocky ~<span class="token punctuation">]</span>$ <span class="token function">vi</span> /apps/redis/etc/sentinel.conf
<span class="token comment" spellcheck="true">#下面列出的就是一些主要修改过的行</span>
bind 0.0.0.0
logfile <span class="token string">"/apps/redis/log/sentinel.log"</span>
sentinel monitor mymaster 10.0.0.8 6379 2
sentinel auth-pass mymaster lgq123456
sentinel down-after-milliseconds mymaster 3000
<span class="token comment" spellcheck="true">##其他的配置选项没做修改</span>

<span class="token comment" spellcheck="true">##从节点1上修改配置文件</span>
<span class="token punctuation">[</span>11:22:20 root@rocky8 ~<span class="token punctuation">]</span>$ <span class="token function">vi</span> /apps/redis/etc/sentinel.conf
<span class="token comment" spellcheck="true">#下面列出的就是一些主要修改过的行</span>
bind 0.0.0.0
logfile <span class="token string">"/apps/redis/log/sentinel.log"</span>
sentinel monitor mymaster 10.0.0.8 6379 2
sentinel auth-pass mymaster lgq123456
sentinel down-after-milliseconds mymaster 3000
<span class="token comment" spellcheck="true">##其他的配置选项没做修改</span>

<span class="token comment" spellcheck="true">##从节点2修改配置文件</span>
<span class="token punctuation">[</span>11:26:59 root@rocky8 ~<span class="token punctuation">]</span>$ <span class="token function">vi</span> /apps/redis/etc/sentinel.conf
<span class="token comment" spellcheck="true">#下面列出的就是一些主要修改过的行</span>
bind 0.0.0.0
logfile <span class="token string">"/apps/redis/log/sentinel.log"</span>
sentinel monitor mymaster 10.0.0.8 6379 2
sentinel auth-pass mymaster lgq123456
sentinel down-after-milliseconds mymaster 3000
<span class="token comment" spellcheck="true">##其他的配置选项没做修改</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="1-2-3-启动哨兵服务"><a href="#1-2-3-启动哨兵服务" class="headerlink" title="1.2.3 启动哨兵服务"></a>1.2.3 启动哨兵服务</h4><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#编译安装的，创建service文件</span>
<span class="token comment" spellcheck="true">#在所有节点生成新的service文件</span>
<span class="token punctuation">[</span>11:32:43 root@rocky ~<span class="token punctuation">]</span>$ <span class="token function">vi</span> /lib/systemd/system/redis-sentinel.service
<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
Description<span class="token operator">=</span>Redis Sentinel
After<span class="token operator">=</span>network.target

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
ExecStart<span class="token operator">=</span>/apps/redis/bin/redis-sentinel /apps/redis/etc/sentinel.conf --supervised systemd
ExecStop<span class="token operator">=</span>/bin/kill -s QUIT <span class="token variable">$MAINPID</span>
User<span class="token operator">=</span>redis
Group<span class="token operator">=</span>redis
RuntimeDirectory<span class="token operator">=</span>redis
RuntimeDirectoryMode<span class="token operator">=</span>0755

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
WantedBy<span class="token operator">=</span>multi-user.target

<span class="token comment" spellcheck="true">#将service文件拷贝至其他两个从节点</span>
<span class="token punctuation">[</span>11:37:17 root@rocky ~<span class="token punctuation">]</span>$ <span class="token function">scp</span> /lib/systemd/system/redis-sentinel.service 10.0.0.18:/lib/systemd/system/
<span class="token punctuation">[</span>11:37:33 root@rocky ~<span class="token punctuation">]</span>$ <span class="token function">scp</span> /lib/systemd/system/redis-sentinel.service 10.0.0.28:/lib/systemd/system/

<span class="token comment" spellcheck="true">#启动sentinel服务</span>
<span class="token punctuation">[</span>11:35:29 root@rocky ~<span class="token punctuation">]</span>$ systemctl <span class="token function">enable</span> --now redis-sentinel.service<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="1-2-4-验证哨兵服务"><a href="#1-2-4-验证哨兵服务" class="headerlink" title="1.2.4 验证哨兵服务"></a>1.2.4 验证哨兵服务</h4><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#1 查看哨兵服务端口状态</span>
<span class="token punctuation">[</span>12:29:26 root@rocky ~<span class="token punctuation">]</span>$ ss -ntl
State      Recv-Q     Send-Q           Local Address:Port            Peer Address:Port     Process     
LISTEN     0          511                    0.0.0.0:26379                0.0.0.0:*                    
LISTEN     0          511                    0.0.0.0:6379                 0.0.0.0:*

<span class="token comment" spellcheck="true">#2 当前sentinel状态</span>
<span class="token comment" spellcheck="true">##在sentinel状态中尤其是最后一行，涉及到masterIP是多少，有几个slave，有几个sentinels，必须是符合全部服务器数量</span>
127.0.0.1:26379<span class="token operator">></span> INFO sentinel
<span class="token comment" spellcheck="true"># Sentinel</span>
sentinel_masters:1
sentinel_tilt:0
sentinel_running_scripts:0
sentinel_scripts_queue_length:0
sentinel_simulate_failure_flags:0
master0:name<span class="token operator">=</span>mymaster,status<span class="token operator">=</span>ok,address<span class="token operator">=</span>10.0.0.8:6379,slaves<span class="token operator">=</span>2,sentinels<span class="token operator">=</span>3 <span class="token comment" spellcheck="true">#两个slave，三个sentinel服务器，如果sentinel值不符合，检查myid可能冲突</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="1-2-5-停止Mster实现故障转移"><a href="#1-2-5-停止Mster实现故障转移" class="headerlink" title="1.2.5 停止Mster实现故障转移"></a>1.2.5 停止Mster实现故障转移</h4><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#1 停止Master节点</span>
<span class="token punctuation">[</span>12:37:00 root@rocky ~<span class="token punctuation">]</span>$ systemctl stop redis

<span class="token comment" spellcheck="true">#2 查看各节点上哨兵信息</span>
<span class="token comment" spellcheck="true">#在原来从节点10.0.0.18上查看</span>
<span class="token punctuation">[</span>12:39:38 root@rocky8 ~<span class="token punctuation">]</span>$ redis-cli -a lgq123456
127.0.0.1:6379<span class="token operator">></span> INFO replication
<span class="token comment" spellcheck="true"># Replication</span>
role:master <span class="token comment" spellcheck="true">#原来是从节点现在提升为了主节点</span>
connected_slaves:1
slave0:ip<span class="token operator">=</span>10.0.0.28,port<span class="token operator">=</span>6379,state<span class="token operator">=</span>online,offset<span class="token operator">=</span>269753,lag<span class="token operator">=</span>1
master_failover_state:no-failover
master_replid:9d20221ff15a2033d123538a784a8265590f62db
master_replid2:785de2f5d49695821aa6153f2bfdf8aa3aa89d3a
master_repl_offset:269753
second_repl_offset:241513
repl_backlog_active:1
repl_backlog_size:1048576
repl_backlog_first_byte_offset:1
repl_backlog_histlen:269753

<span class="token comment" spellcheck="true">#在10.0.0.28上观察状态</span>
127.0.0.1:6379<span class="token operator">></span> INFO replication
<span class="token comment" spellcheck="true"># Replication</span>
role:slave
master_host:10.0.0.18 <span class="token comment" spellcheck="true">#改为10.0.0.18为其主节点了</span>
master_port:6379
master_link_status:up
master_last_io_seconds_ago:1
master_sync_in_progress:0
slave_read_repl_offset:306356
slave_repl_offset:306356
slave_priority:100
slave_read_only:1
replica_announced:1
connected_slaves:0
master_failover_state:no-failover
master_replid:9d20221ff15a2033d123538a784a8265590f62db
master_replid2:785de2f5d49695821aa6153f2bfdf8aa3aa89d3a
master_repl_offset:306356
second_repl_offset:241513
repl_backlog_active:1
repl_backlog_size:1048576
repl_backlog_first_byte_offset:15
repl_backlog_histlen:306342

<span class="token comment" spellcheck="true">#3 故障转移时sentinel信息</span>
<span class="token punctuation">[</span>12:29:30 root@rocky ~<span class="token punctuation">]</span>$ <span class="token function">tail</span> -f /apps/redis/log/sentinel.log
2752:X 27 Oct 2022 12:37:46.644 <span class="token comment" spellcheck="true"># +sdown master mymaster 10.0.0.8 6379</span>
2752:X 27 Oct 2022 12:37:46.701 <span class="token comment" spellcheck="true"># +new-epoch 1</span>
2752:X 27 Oct 2022 12:37:46.703 <span class="token comment" spellcheck="true"># +vote-for-leader bb0bb2967f9d97cf868e7a658238cc24dc8ab47a 1</span>
2752:X 27 Oct 2022 12:37:46.709 <span class="token comment" spellcheck="true"># +odown master mymaster 10.0.0.8 6379 #quorum 3/2</span>
2752:X 27 Oct 2022 12:37:46.709 <span class="token comment" spellcheck="true"># Next failover delay: I will not start a failover before Thu Oct 27 12:43:46 2022</span>
2752:X 27 Oct 2022 12:37:47.772 <span class="token comment" spellcheck="true"># +config-update-from sentinel bb0bb2967f9d97cf868e7a658238cc24dc8ab47a 10.0.0.18 26379 @ mymaster 10.0.0.8 6379</span>
2752:X 27 Oct 2022 12:37:47.773 <span class="token comment" spellcheck="true"># +switch-master mymaster 10.0.0.8 6379 10.0.0.18 6379</span>
2752:X 27 Oct 2022 12:37:47.774 * +slave slave 10.0.0.28:6379 10.0.0.28 6379 @ mymaster 10.0.0.18 6379
2752:X 27 Oct 2022 12:37:47.774 * +slave slave 10.0.0.8:6379 10.0.0.8 6379 @ mymaster 10.0.0.18 6379
2752:X 27 Oct 2022 12:37:50.813 <span class="token comment" spellcheck="true"># +sdown slave 10.0.0.8:6379 10.0.0.8 6379 @ mymaster 10.0.0.18 6379</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="1-2-6-验证故障转移"><a href="#1-2-6-验证故障转移" class="headerlink" title="1.2.6 验证故障转移"></a>1.2.6 验证故障转移</h4><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#故障转移后redis.conf中的replicaof行的master IP会被修改</span>
<span class="token comment" spellcheck="true">#在10.0.0.28上查看</span>
<span class="token punctuation">[</span>12:47:44 root@rocky8 ~<span class="token punctuation">]</span>$ <span class="token function">grep</span> ^replicaof /apps/redis/etc/redis.conf 
replicaof 10.0.0.18 6379 <span class="token comment" spellcheck="true">#切换成了10.0.0.18</span>

<span class="token comment" spellcheck="true">#哨兵配置文件的sentinel monitor IP 同样也会被修改</span>
<span class="token punctuation">[</span>12:48:02 root@rocky8 ~<span class="token punctuation">]</span>$ <span class="token function">grep</span> <span class="token string">"^[a-Z]"</span> /apps/redis/etc/sentinel.conf 
bind 0.0.0.0
port 26379
daemonize no
pidfile <span class="token string">"/var/run/redis-sentinel.pid"</span>
logfile <span class="token string">"/apps/redis/log/sentinel.log"</span>
<span class="token function">dir</span> <span class="token string">"/tmp"</span>
sentinel monitor mymaster 10.0.0.18 6379 2 <span class="token comment" spellcheck="true">#主节点的IP地址也换了</span>
sentinel auth-pass mymaster lgq123456
sentinel down-after-milliseconds mymaster 3000
acllog-max-len 128
sentinel deny-scripts-reconfig <span class="token function">yes</span>
sentinel resolve-hostnames no
sentinel announce-hostnames no
protected-mode no
supervised systemd
user default on nopass ~* <span class="token operator">&amp;</span>* +@all
sentinel myid 50d92394837a013456af8a5b36931d37b2a5f0c5
sentinel config-epoch mymaster 1
sentinel leader-epoch mymaster 1
sentinel current-epoch 1
sentinel known-replica mymaster 10.0.0.28 6379
sentinel known-replica mymaster 10.0.0.8 6379
sentinel known-sentinel mymaster 10.0.0.8 26379 1baea43d8ae61c17d90577b63034595d2d7e0080
sentinel known-sentinel mymaster 10.0.0.18 26379 bb0bb2967f9d97cf868e7a658238cc24dc8ab47a<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="1-2-7-原master重新加入Redis集群"><a href="#1-2-7-原master重新加入Redis集群" class="headerlink" title="1.2.7 原master重新加入Redis集群"></a>1.2.7 原master重新加入Redis集群</h4><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#重启原master节点redis服务</span>
<span class="token punctuation">[</span>12:37:43 root@rocky ~<span class="token punctuation">]</span>$ systemctl start redis
<span class="token comment" spellcheck="true">#发现其配置文件中添加了现在主节点的信息</span>
<span class="token punctuation">[</span>12:51:52 root@rocky ~<span class="token punctuation">]</span>$ <span class="token function">grep</span> ^replicaof /apps/redis/etc/redis.conf 
replicaof 10.0.0.18 6379
<span class="token punctuation">[</span>12:55:56 root@rocky ~<span class="token punctuation">]</span>$ <span class="token function">grep</span> ^<span class="token punctuation">[</span>a-z<span class="token punctuation">]</span> /apps/redis/etc/sentinel.conf 
bind 0.0.0.0
port 26379
daemonize no
pidfile <span class="token string">"/var/run/redis-sentinel.pid"</span>
logfile <span class="token string">"/apps/redis/log/sentinel.log"</span>
<span class="token function">dir</span> <span class="token string">"/tmp"</span>
sentinel monitor mymaster 10.0.0.18 6379 2
sentinel auth-pass mymaster lgq123456
sentinel down-after-milliseconds mymaster 3000
acllog-max-len 128
sentinel deny-scripts-reconfig <span class="token function">yes</span>
sentinel resolve-hostnames no
sentinel announce-hostnames no
protected-mode no
supervised systemd
user default on nopass ~* <span class="token operator">&amp;</span>* +@all
sentinel myid 1baea43d8ae61c17d90577b63034595d2d7e0080
sentinel config-epoch mymaster 1
sentinel leader-epoch mymaster 1
sentinel current-epoch 1
sentinel known-replica mymaster 10.0.0.8 6379
sentinel known-replica mymaster 10.0.0.28 6379
sentinel known-sentinel mymaster 10.0.0.18 26379 bb0bb2967f9d97cf868e7a658238cc24dc8ab47a
sentinel known-sentinel mymaster 10.0.0.28 26379 50d92394837a013456af8a5b36931d37b2a5f0c5

<span class="token comment" spellcheck="true">#查看其状态</span>
127.0.0.1:6379<span class="token operator">></span> INFO replication
<span class="token comment" spellcheck="true"># Replication</span>
role:slave <span class="token comment" spellcheck="true">#变成了从节点</span>
master_host:10.0.0.18 <span class="token comment" spellcheck="true">#主节点IP </span>
master_port:6379
master_link_status:up
master_last_io_seconds_ago:1
master_sync_in_progress:0
slave_read_repl_offset:431834
slave_repl_offset:431834
slave_priority:100
slave_read_only:1
replica_announced:1
connected_slaves:0
min_slaves_good_slaves:0
master_failover_state:no-failover
master_replid:9d20221ff15a2033d123538a784a8265590f62db
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:431834
second_repl_offset:-1
repl_backlog_active:1
repl_backlog_size:1048576
repl_backlog_first_byte_offset:409238
repl_backlog_histlen:22597


<span class="token comment" spellcheck="true">#观察新master上的状态</span>
127.0.0.1:6379<span class="token operator">></span> INFO replication
<span class="token comment" spellcheck="true"># Replication</span>
role:master
connected_slaves:2
slave0:ip<span class="token operator">=</span>10.0.0.28,port<span class="token operator">=</span>6379,state<span class="token operator">=</span>online,offset<span class="token operator">=</span>466831,lag<span class="token operator">=</span>1
slave1:ip<span class="token operator">=</span>10.0.0.8,port<span class="token operator">=</span>6379,state<span class="token operator">=</span>online,offset<span class="token operator">=</span>466831,lag<span class="token operator">=</span>1
master_failover_state:no-failover
master_replid:9d20221ff15a2033d123538a784a8265590f62db
master_replid2:785de2f5d49695821aa6153f2bfdf8aa3aa89d3a
master_repl_offset:466964
second_repl_offset:241513
repl_backlog_active:1
repl_backlog_size:1048576
repl_backlog_first_byte_offset:1
repl_backlog_histlen:466964<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="2-LVS常用模型工作原理及实现。"><a href="#2-LVS常用模型工作原理及实现。" class="headerlink" title="2 LVS常用模型工作原理及实现。"></a>2 LVS常用模型工作原理及实现。</h2><ul>
<li><code>lvs-nat</code>：本质是多目标IP的<code>DNAT</code>，通过将请求报文中的目标地址和目标端口修改为某挑出的<code>RS</code>的<code>RIP</code>和<code>PORT</code>实现转发</li>
<li><code>lvs-dr</code>：<code>Direct Routing</code>，直接路由，LVS默认模式,应用最广泛,通过为请求报文重新封装一个<code>MAC</code>首部进行转发，源<code>MAC</code>是<code>DIP</code>所在的接口的<code>MAC</code>，目标<code>MAC</code>是某挑选出的<code>RS</code>的<code>RIP</code>所在接口的MAC地址；源<code>IP/PORT</code>，以及目标<code>IP/PORT</code>均保持不变</li>
<li><code>lvs-tun</code>：不修改请求报文的IP首部（源IP为CIP，目标IP为VIP），而在原IP报文之外再封装一个IP首部（源IP是DIP，目标IP是RIP），将报文发往挑选出的目标RS；RS直接响应给客户端（源IP是VIP，目标IP是CIP）</li>
<li><code>lvs-fullnat</code>：修改请求报文的源和目标IP,默认内核不支持</li>
</ul>
<h2 id="3-LVS的负载策略有哪些，各应用在什么场景，通过LVS-DR任意实现1-2种场景。"><a href="#3-LVS的负载策略有哪些，各应用在什么场景，通过LVS-DR任意实现1-2种场景。" class="headerlink" title="3 LVS的负载策略有哪些，各应用在什么场景，通过LVS DR任意实现1-2种场景。"></a>3 LVS的负载策略有哪些，各应用在什么场景，通过LVS DR任意实现1-2种场景。</h2><h3 id="3-1-负载策略"><a href="#3-1-负载策略" class="headerlink" title="3.1 负载策略"></a>3.1 负载策略</h3><h4 id="3-1-1-静态方法"><a href="#3-1-1-静态方法" class="headerlink" title="3.1.1 静态方法"></a>3.1.1 静态方法</h4><p>仅根据算法本身进行调度</p>
<ol>
<li><code>RR</code>：<code>roundrobin</code>，轮询,较常用，雨露均沾，大锅饭</li>
<li><code>WRR</code>：<code>Weighted RR</code>，加权轮询,较常用</li>
<li><code>SH</code>：<code>Source Hashing</code>，实现<code>session sticky</code>，源IP地址hash；将来自于同一个IP地址的请求始终发往第一次挑中的RS，从而实现会话绑定</li>
<li><code>DH</code>：<code>Destination Hashing</code>；目标地址哈希，第一次轮询调度至RS，后续将发往同一个目标地址的请求始终转发至第一次挑中的RS，典型使用场景是正向代理缓存场景中的负载均衡,如: Web缓存</li>
</ol>
<h4 id="3-1-2-动态方法"><a href="#3-1-2-动态方法" class="headerlink" title="3.1.2 动态方法"></a>3.1.2 动态方法</h4><p>主要根据每RS当前的负载状态及调度算法进行调度<code>Overhead=value</code>较小的RS将被调度</p>
<ol>
<li><p><code>LC</code>：<code>least connections</code>适用于长连接应用</p>
<pre class="line-numbers language-bash"><code class="language-bash">Overhead<span class="token operator">=</span>activeconns*256+inactiveconns<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p><code>WLC</code>：<code>Weighted LC</code>，默认调度方法,较常用</p>
<pre class="line-numbers language-bash"><code class="language-bash">Overhead<span class="token operator">=</span><span class="token punctuation">(</span>activeconns*256+inactiveconns<span class="token punctuation">)</span>/weight<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p><code>SED</code>：<code>Shortest Expection Delay</code>，初始连接高权重优先,只检查活动连接,而不考虑非活动连接</p>
<pre class="line-numbers language-bash"><code class="language-bash">Overhead<span class="token operator">=</span><span class="token punctuation">(</span>activeconns+1<span class="token punctuation">)</span>*256/weight<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p><code>NQ</code>：<code>Never Queue</code>，第一轮均匀分配，后续<code>SED</code></p>
</li>
<li><p><code>LBLC</code>：<code>Locality-Based LC</code>，动态的<code>DH</code>算法，使用场景：根据负载状态实现正向代理,实现Web Cache等</p>
</li>
<li><p><code>LBLCR</code>：<code>LBLC with Replication</code>，带复制功能的<code>LBLC</code>，解决<code>LBLC</code>负载不均衡问题，从负载重的复制到负载轻的RS,实现Web Cache等</p>
</li>
</ol>
<h3 id="3-2-DR案例"><a href="#3-2-DR案例" class="headerlink" title="3.2 DR案例"></a>3.2 DR案例</h3><h4 id="3-2-1-LVS-DR模式单网段案例"><a href="#3-2-1-LVS-DR模式单网段案例" class="headerlink" title="3.2.1 LVS-DR模式单网段案例"></a>3.2.1 LVS-DR模式单网段案例</h4><p><img src="https://yanlinuxblog.oss-cn-hangzhou.aliyuncs.com/img/image-20221029102628535.png" alt=""></p>
<p>1 LVS的网络配置</p>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#1 RS1的网络配置</span>
<span class="token comment" spellcheck="true">##安装配置httpd</span>
<span class="token punctuation">[</span>16:05:40 root@centos7 ~<span class="token punctuation">]</span>$ yum -y <span class="token function">install</span> httpd mod_ssl redis
<span class="token punctuation">[</span>16:07:02 root@centos7 ~<span class="token punctuation">]</span>$ systemctl <span class="token function">enable</span> --now httpd redis
<span class="token punctuation">[</span>16:07:47 root@centos7 ~<span class="token punctuation">]</span>$ hostnamectl set-hostname web1
<span class="token punctuation">[</span>16:25:26 root@web1 ~<span class="token punctuation">]</span>$ <span class="token function">hostname</span> <span class="token operator">></span> /var/www/html/index.html

<span class="token punctuation">[</span>10:31:03 root@web1 /etc/sysconfig/network-scripts<span class="token punctuation">]</span>$ <span class="token function">cat</span> ifcfg-eth0 
BOOTPROTO<span class="token operator">=</span><span class="token string">"static"</span>
NAME<span class="token operator">=</span><span class="token string">"eth0"</span>
DEVICE<span class="token operator">=</span><span class="token string">"eth0"</span>
IPADDR<span class="token operator">=</span>10.0.0.7
PREFIX<span class="token operator">=</span>24
GATEWAY<span class="token operator">=</span>10.0.0.200
ONBOOT<span class="token operator">=</span>yes
<span class="token punctuation">[</span>10:38:28 root@web1 ~<span class="token punctuation">]</span>$ route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         10.0.0.200      0.0.0.0         UG    100    0        0 eth0
10.0.0.0        0.0.0.0         255.255.255.0   U     100    0        0 eth0

<span class="token comment" spellcheck="true">#2 RS2的网络配置</span>
<span class="token punctuation">[</span>16:05:40 root@centos7 ~<span class="token punctuation">]</span>$ yum -y <span class="token function">install</span> httpd mod_ssl redis
<span class="token punctuation">[</span>16:07:02 root@centos7 ~<span class="token punctuation">]</span>$ systemctl <span class="token function">enable</span> --now httpd redis
<span class="token punctuation">[</span>16:07:47 root@centos7 ~<span class="token punctuation">]</span>$ hostnamectl set-hostname web2
<span class="token punctuation">[</span>16:25:26 root@web2 ~<span class="token punctuation">]</span>$ <span class="token function">hostname</span> <span class="token operator">></span> /var/www/html/index.html
<span class="token punctuation">[</span>11:25:20 root@web2 /etc/sysconfig/network-scripts<span class="token punctuation">]</span>$ <span class="token function">vi</span> ifcfg-eth0 
BOOTPROTO<span class="token operator">=</span><span class="token string">"static"</span>
NAME<span class="token operator">=</span><span class="token string">"eth0"</span>
DEVICE<span class="token operator">=</span><span class="token string">"eth0"</span>
IPADDR<span class="token operator">=</span>10.0.0.17
PREFIX<span class="token operator">=</span>24
GATEWAY<span class="token operator">=</span>10.0.0.200
ONBOOT<span class="token operator">=</span><span class="token string">"yes"</span>
<span class="token punctuation">[</span>11:25:53 root@web2 /etc/sysconfig/network-scripts<span class="token punctuation">]</span>$ nmcli connection reload
<span class="token punctuation">[</span>11:26:09 root@web2 /etc/sysconfig/network-scripts<span class="token punctuation">]</span>$ nmcli connection up eth0
<span class="token punctuation">[</span>11:26:21 root@web2 /etc/sysconfig/network-scripts<span class="token punctuation">]</span>$ route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         10.0.0.200      0.0.0.0         UG    100    0        0 eth0
10.0.0.0        0.0.0.0         255.255.255.0   U     100    0        0 eth0


<span class="token comment" spellcheck="true">#3 insternet网络配置</span>
<span class="token punctuation">[</span>10:55:23 root@rocky ~<span class="token punctuation">]</span>$ hostnamectl set-hostname internet
<span class="token punctuation">[</span>10:56:32 root@internet /etc/sysconfig/network-scripts<span class="token punctuation">]</span>$ <span class="token function">cat</span> ifcfg-eth0 
BOOTPROTO<span class="token operator">=</span>static
NAME<span class="token operator">=</span>eth0
DEVICE<span class="token operator">=</span>eth0
IPADDR<span class="token operator">=</span>192.168.10.6
PREFIX<span class="token operator">=</span>24
GATEWAY<span class="token operator">=</span>192.168.10.200
ONBOOT<span class="token operator">=</span>yes
<span class="token punctuation">[</span>10:57:13 root@internet ~<span class="token punctuation">]</span>$ route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         192.168.10.200  0.0.0.0         UG    100    0        0 eth0
192.168.10.0    0.0.0.0         255.255.255.0   U     100    0        0 eth0

<span class="token comment" spellcheck="true">#4 router网络配置</span>
<span class="token comment" spellcheck="true">##开启ip_forward</span>
<span class="token punctuation">[</span>10:50:21 root@router ~<span class="token punctuation">]</span>$ <span class="token keyword">echo</span> <span class="token string">'net.ipv4.ip_forward=1'</span> <span class="token operator">>></span>/etc/sysctl.conf 
<span class="token punctuation">[</span>10:59:39 root@router ~<span class="token punctuation">]</span>$ sysctl -p
net.ipv4.ip_forward <span class="token operator">=</span> 1
<span class="token punctuation">[</span>11:11:57 root@router netplan<span class="token punctuation">]</span>$ <span class="token function">cat</span> 00-installer-config.yaml 
<span class="token comment" spellcheck="true"># This is the network config written by 'subiquity'</span>
network: 
  version: 2 
  renderer: networkd
  ethernets:
    eth0:
      addresses:
        - 10.0.0.200/24
      gateway4: 10.0.0.2
      nameservers:
        addresses: <span class="token punctuation">[</span>180.76.76.76, 114.114.114.114<span class="token punctuation">]</span>
    eth1:
      addresses:
        - 192.168.10.200/24
<span class="token punctuation">[</span>11:12:00 root@router netplan<span class="token punctuation">]</span>$ netplan apply
<span class="token comment" spellcheck="true">##测试网络通不通</span>
<span class="token punctuation">[</span>11:14:18 root@router ~<span class="token punctuation">]</span>$ curl 10.0.0.7
web1
<span class="token punctuation">[</span>11:14:26 root@router ~<span class="token punctuation">]</span>$ curl 10.0.0.17
web2
<span class="token punctuation">[</span>11:14:28 root@router ~<span class="token punctuation">]</span>$ <span class="token function">ping</span> 192.168.10.6
PING 192.168.10.6 <span class="token punctuation">(</span>192.168.10.6<span class="token punctuation">)</span> 56<span class="token punctuation">(</span>84<span class="token punctuation">)</span> bytes of data.
64 bytes from 192.168.10.6: icmp_seq<span class="token operator">=</span>1 ttl<span class="token operator">=</span>64 time<span class="token operator">=</span>0.526 ms
64 bytes from 192.168.10.6: icmp_seq<span class="token operator">=</span>2 ttl<span class="token operator">=</span>64 time<span class="token operator">=</span>0.733 ms
64 bytes from 192.168.10.6: icmp_seq<span class="token operator">=</span>3 ttl<span class="token operator">=</span>64 time<span class="token operator">=</span>0.924 ms


<span class="token comment" spellcheck="true">#5 LVS服务器的网络配置</span>
<span class="token punctuation">[</span>11:28:20 root@LVS network-scripts<span class="token punctuation">]</span>$ <span class="token function">vi</span> ifcfg-eth0
BOOTPROTO<span class="token operator">=</span>static
NAME<span class="token operator">=</span>eth0
DEVICE<span class="token operator">=</span>eth0
IPADDR<span class="token operator">=</span>10.0.0.8
PREFIX<span class="token operator">=</span>24
GATEWAY<span class="token operator">=</span>10.0.0.200
ONBOOT<span class="token operator">=</span>yes
<span class="token punctuation">[</span>11:30:03 root@LVS network-scripts<span class="token punctuation">]</span>$ nmcli connection reload
<span class="token punctuation">[</span>11:30:20 root@LVS network-scripts<span class="token punctuation">]</span>$ nmcli connection up eth0
<span class="token punctuation">[</span>11:29:53 root@LVS network-scripts<span class="token punctuation">]</span>$ route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         10.0.0.2        0.0.0.0         UG    100    0        0 eth0
10.0.0.0        0.0.0.0         255.255.255.0   U     100    0        0 eth0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2 后端RS的IPVS配置</p>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#RS1的IPVS配置</span>
<span class="token comment" spellcheck="true">##下面是临时生效的，想要永久生效就得写到/etc/sysctl.conf中</span>
<span class="token punctuation">[</span>11:42:27 root@web1 ~<span class="token punctuation">]</span>$ <span class="token keyword">echo</span> 1 <span class="token operator">></span> /proc/sys/net/ipv4/conf/all/arp_ignore
<span class="token punctuation">[</span>11:43:58 root@web1 ~<span class="token punctuation">]</span>$ <span class="token keyword">echo</span> 2 <span class="token operator">></span> /proc/sys/net/ipv4/conf/all/arp_announce
<span class="token punctuation">[</span>11:44:06 root@web1 ~<span class="token punctuation">]</span>$ <span class="token keyword">echo</span> 1 <span class="token operator">></span> /proc/sys/net/ipv4/conf/lo/arp_ignore
<span class="token punctuation">[</span>11:44:15 root@web1 ~<span class="token punctuation">]</span>$ <span class="token keyword">echo</span> 2 <span class="token operator">></span> /proc/sys/net/ipv4/conf/lo/arp_announce
<span class="token comment" spellcheck="true">##加上VIP到回环网卡上</span>
<span class="token punctuation">[</span>11:47:17 root@web1 ~<span class="token punctuation">]</span>$ ip a a 10.0.0.100/32 dev lo label lo:1
<span class="token punctuation">[</span>11:47:46 root@web1 ~<span class="token punctuation">]</span>$ <span class="token function">ifconfig</span> 
eth0: flags<span class="token operator">=</span>4163<span class="token operator">&lt;</span>UP,BROADCAST,RUNNING,MULTICAST<span class="token operator">></span>  mtu 1500
        inet 10.0.0.7  netmask 255.255.255.0  broadcast 10.0.0.255
        inet6 fe80::20c:29ff:feba:abf1  prefixlen 64  scopeid 0x20<span class="token operator">&lt;</span>link<span class="token operator">></span>
        ether 00:0c:29:ba:ab:f1  txqueuelen 1000  <span class="token punctuation">(</span>Ethernet<span class="token punctuation">)</span>
        RX packets 1585  bytes 134157 <span class="token punctuation">(</span>131.0 KiB<span class="token punctuation">)</span>
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 1262  bytes 135781 <span class="token punctuation">(</span>132.5 KiB<span class="token punctuation">)</span>
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

lo: flags<span class="token operator">=</span>73<span class="token operator">&lt;</span>UP,LOOPBACK,RUNNING<span class="token operator">></span>  mtu 65536
        inet 127.0.0.1  netmask 255.0.0.0
        inet6 ::1  prefixlen 128  scopeid 0x10<span class="token operator">&lt;</span>host<span class="token operator">></span>
        loop  txqueuelen 1000  <span class="token punctuation">(</span>Local Loopback<span class="token punctuation">)</span>
        RX packets 144  bytes 12736 <span class="token punctuation">(</span>12.4 KiB<span class="token punctuation">)</span>
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 144  bytes 12736 <span class="token punctuation">(</span>12.4 KiB<span class="token punctuation">)</span>
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

lo:1: flags<span class="token operator">=</span>73<span class="token operator">&lt;</span>UP,LOOPBACK,RUNNING<span class="token operator">></span>  mtu 65536
        inet 10.0.0.100  netmask 255.255.255.255
        loop  txqueuelen 1000  <span class="token punctuation">(</span>Local Loopback<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">#RS2的IPVS配置</span>
<span class="token punctuation">[</span>11:44:46 root@web2 ~<span class="token punctuation">]</span>$ <span class="token keyword">echo</span> 1 <span class="token operator">></span> /proc/sys/net/ipv4/conf/all/arp_ignore
<span class="token punctuation">[</span>11:44:51 root@web2 ~<span class="token punctuation">]</span>$ <span class="token keyword">echo</span> 2 <span class="token operator">></span> /proc/sys/net/ipv4/conf/all/arp_announce
<span class="token punctuation">[</span>11:44:59 root@web2 ~<span class="token punctuation">]</span>$ <span class="token keyword">echo</span> 1 <span class="token operator">></span> /proc/sys/net/ipv4/conf/lo/arp_ignore
<span class="token punctuation">[</span>11:45:05 root@web2 ~<span class="token punctuation">]</span>$ <span class="token keyword">echo</span> 2 <span class="token operator">></span> /proc/sys/net/ipv4/conf/lo/arp_announce
<span class="token punctuation">[</span>11:46:23 root@web2 ~<span class="token punctuation">]</span>$ <span class="token function">ifconfig</span> lo:1 10.0.0.100/32
<span class="token punctuation">[</span>11:50:07 root@web2 ~<span class="token punctuation">]</span>$ <span class="token function">ifconfig</span> 
eth0: flags<span class="token operator">=</span>4163<span class="token operator">&lt;</span>UP,BROADCAST,RUNNING,MULTICAST<span class="token operator">></span>  mtu 1500
        inet 10.0.0.17  netmask 255.255.255.0  broadcast 10.0.0.255
        inet6 fe80::20c:29ff:fef0:b9b8  prefixlen 64  scopeid 0x20<span class="token operator">&lt;</span>link<span class="token operator">></span>
        ether 00:0c:29:f0:b9:b8  txqueuelen 1000  <span class="token punctuation">(</span>Ethernet<span class="token punctuation">)</span>
        RX packets 1319  bytes 112281 <span class="token punctuation">(</span>109.6 KiB<span class="token punctuation">)</span>
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 949  bytes 111613 <span class="token punctuation">(</span>108.9 KiB<span class="token punctuation">)</span>
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

lo: flags<span class="token operator">=</span>73<span class="token operator">&lt;</span>UP,LOOPBACK,RUNNING<span class="token operator">></span>  mtu 65536
        inet 127.0.0.1  netmask 255.0.0.0
        inet6 ::1  prefixlen 128  scopeid 0x10<span class="token operator">&lt;</span>host<span class="token operator">></span>
        loop  txqueuelen 1000  <span class="token punctuation">(</span>Local Loopback<span class="token punctuation">)</span>
        RX packets 53  bytes 4212 <span class="token punctuation">(</span>4.1 KiB<span class="token punctuation">)</span>
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 53  bytes 4212 <span class="token punctuation">(</span>4.1 KiB<span class="token punctuation">)</span>
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

lo:1: flags<span class="token operator">=</span>73<span class="token operator">&lt;</span>UP,LOOPBACK,RUNNING<span class="token operator">></span>  mtu 65536
        inet 10.0.0.100  netmask 0.0.0.0
        loop  txqueuelen 1000  <span class="token punctuation">(</span>Local Loopback<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>3 LVS主机的配置</p>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#在LVS上添加VIP</span>
<span class="token punctuation">[</span>11:59:02 root@LVS ~<span class="token punctuation">]</span>$ <span class="token function">ifconfig</span> lo:1 10.0.0.100/32
<span class="token punctuation">[</span>12:00:58 root@LVS ~<span class="token punctuation">]</span>$ <span class="token function">ifconfig</span> 
eth0: flags<span class="token operator">=</span>4163<span class="token operator">&lt;</span>UP,BROADCAST,RUNNING,MULTICAST<span class="token operator">></span>  mtu 1500
        inet 10.0.0.8  netmask 255.255.255.0  broadcast 10.0.0.255
        inet6 fe80::20c:29ff:feb9:2bb4  prefixlen 64  scopeid 0x20<span class="token operator">&lt;</span>link<span class="token operator">></span>
        ether 00:0c:29:b9:2b:b4  txqueuelen 1000  <span class="token punctuation">(</span>Ethernet<span class="token punctuation">)</span>
        RX packets 180  bytes 15534 <span class="token punctuation">(</span>15.1 KiB<span class="token punctuation">)</span>
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 141  bytes 12191 <span class="token punctuation">(</span>11.9 KiB<span class="token punctuation">)</span>
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

lo: flags<span class="token operator">=</span>73<span class="token operator">&lt;</span>UP,LOOPBACK,RUNNING<span class="token operator">></span>  mtu 65536
        inet 127.0.0.1  netmask 255.0.0.0
        inet6 ::1  prefixlen 128  scopeid 0x10<span class="token operator">&lt;</span>host<span class="token operator">></span>
        loop  txqueuelen 1000  <span class="token punctuation">(</span>Local Loopback<span class="token punctuation">)</span>
        RX packets 12  bytes 1020 <span class="token punctuation">(</span>1020.0 B<span class="token punctuation">)</span>
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 12  bytes 1020 <span class="token punctuation">(</span>1020.0 B<span class="token punctuation">)</span>
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

lo:1: flags<span class="token operator">=</span>73<span class="token operator">&lt;</span>UP,LOOPBACK,RUNNING<span class="token operator">></span>  mtu 65536
        inet 10.0.0.100  netmask 0.0.0.0
        loop  txqueuelen 1000  <span class="token punctuation">(</span>Local Loopback<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">#添加LVS规则</span>
<span class="token punctuation">[</span>12:01:03 root@LVS ~<span class="token punctuation">]</span>$ ipvsadm -A -t 10.0.0.100:80 -s rr
<span class="token punctuation">[</span>12:03:13 root@LVS ~<span class="token punctuation">]</span>$ ipvsadm -a -t 10.0.0.100:80 -r 10.0.0.7:80 -g
<span class="token punctuation">[</span>12:03:41 root@LVS ~<span class="token punctuation">]</span>$ ipvsadm -a -t 10.0.0.100:80 -r 10.0.0.17:80 -g
<span class="token punctuation">[</span>12:03:45 root@LVS ~<span class="token punctuation">]</span>$ ipvsadm -Ln 
IP Virtual Server version 1.2.1 <span class="token punctuation">(</span>size<span class="token operator">=</span>4096<span class="token punctuation">)</span>
Prot LocalAddress:Port Scheduler Flags
  -<span class="token operator">></span> RemoteAddress:Port           Forward Weight ActiveConn InActConn
TCP  10.0.0.100:80 rr
  -<span class="token operator">></span> 10.0.0.7:80                   Route   1      0          0         
  -<span class="token operator">></span> 10.0.0.17:80                  Route   1      0          0 <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>4 测试访问</p>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">[</span>12:04:55 root@internet ~<span class="token punctuation">]</span>$ curl 10.0.0.100
web1
<span class="token punctuation">[</span>12:05:57 root@internet ~<span class="token punctuation">]</span>$ curl 10.0.0.100
web2
<span class="token punctuation">[</span>12:05:58 root@internet ~<span class="token punctuation">]</span>$ curl 10.0.0.100
web1
<span class="token punctuation">[</span>12:05:59 root@internet ~<span class="token punctuation">]</span>$ curl 10.0.0.100
web2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="3-2-2-LVS-DR模式多网段案例"><a href="#3-2-2-LVS-DR模式多网段案例" class="headerlink" title="3.2.2 LVS-DR模式多网段案例"></a>3.2.2 LVS-DR模式多网段案例</h4><p>单网段的DR模式容易暴露后端RS服务器地址信息,可以使用跨网面的DR模型,实现更高的安全性</p>
<p><img src="https://yanlinuxblog.oss-cn-hangzhou.aliyuncs.com/img/image-20221029163518442.png" alt=""></p>
<p>1 各个服务器的网络配置</p>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#1 RS1的网络配置</span>
<span class="token comment" spellcheck="true">##安装配置httpd</span>
<span class="token punctuation">[</span>16:05:40 root@centos7 ~<span class="token punctuation">]</span>$ yum -y <span class="token function">install</span> httpd mod_ssl redis
<span class="token punctuation">[</span>16:07:02 root@centos7 ~<span class="token punctuation">]</span>$ systemctl <span class="token function">enable</span> --now httpd redis
<span class="token punctuation">[</span>16:07:47 root@centos7 ~<span class="token punctuation">]</span>$ hostnamectl set-hostname web1
<span class="token punctuation">[</span>16:25:26 root@web1 ~<span class="token punctuation">]</span>$ <span class="token function">hostname</span> <span class="token operator">></span> /var/www/html/index.html
<span class="token punctuation">[</span>10:31:03 root@web1 /etc/sysconfig/network-scripts<span class="token punctuation">]</span>$ <span class="token function">cat</span> ifcfg-eth0 
BOOTPROTO<span class="token operator">=</span><span class="token string">"static"</span>
NAME<span class="token operator">=</span><span class="token string">"eth0"</span>
DEVICE<span class="token operator">=</span><span class="token string">"eth0"</span>
IPADDR<span class="token operator">=</span>10.0.0.7
PREFIX<span class="token operator">=</span>24
GATEWAY<span class="token operator">=</span>10.0.0.200
ONBOOT<span class="token operator">=</span>yes
<span class="token punctuation">[</span>10:38:28 root@web1 ~<span class="token punctuation">]</span>$ route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         10.0.0.200      0.0.0.0         UG    100    0        0 eth0
10.0.0.0        0.0.0.0         255.255.255.0   U     100    0        0 eth0


<span class="token comment" spellcheck="true">#2 RS2的网络配置</span>
<span class="token punctuation">[</span>16:05:40 root@centos7 ~<span class="token punctuation">]</span>$ yum -y <span class="token function">install</span> httpd mod_ssl redis
<span class="token punctuation">[</span>16:07:02 root@centos7 ~<span class="token punctuation">]</span>$ systemctl <span class="token function">enable</span> --now httpd redis
<span class="token punctuation">[</span>16:07:47 root@centos7 ~<span class="token punctuation">]</span>$ hostnamectl set-hostname web2
<span class="token punctuation">[</span>16:25:26 root@web2 ~<span class="token punctuation">]</span>$ <span class="token function">hostname</span> <span class="token operator">></span> /var/www/html/index.html
<span class="token punctuation">[</span>11:25:20 root@web2 /etc/sysconfig/network-scripts<span class="token punctuation">]</span>$ <span class="token function">vi</span> ifcfg-eth0 
BOOTPROTO<span class="token operator">=</span><span class="token string">"static"</span>
NAME<span class="token operator">=</span><span class="token string">"eth0"</span>
DEVICE<span class="token operator">=</span><span class="token string">"eth0"</span>
IPADDR<span class="token operator">=</span>10.0.0.17
PREFIX<span class="token operator">=</span>24
GATEWAY<span class="token operator">=</span>10.0.0.200
ONBOOT<span class="token operator">=</span><span class="token string">"yes"</span>
<span class="token punctuation">[</span>11:25:53 root@web2 /etc/sysconfig/network-scripts<span class="token punctuation">]</span>$ nmcli connection reload
<span class="token punctuation">[</span>11:26:09 root@web2 /etc/sysconfig/network-scripts<span class="token punctuation">]</span>$ nmcli connection up eth0
<span class="token punctuation">[</span>11:26:21 root@web2 /etc/sysconfig/network-scripts<span class="token punctuation">]</span>$ route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         10.0.0.200      0.0.0.0         UG    100    0        0 eth0
10.0.0.0        0.0.0.0         255.255.255.0   U     100    0        0 eth0


<span class="token comment" spellcheck="true">#3 insternet网络配置</span>
<span class="token punctuation">[</span>10:55:23 root@rocky ~<span class="token punctuation">]</span>$ hostnamectl set-hostname internet
<span class="token punctuation">[</span>10:56:32 root@internet /etc/sysconfig/network-scripts<span class="token punctuation">]</span>$ <span class="token function">cat</span> ifcfg-eth0 
BOOTPROTO<span class="token operator">=</span>static
NAME<span class="token operator">=</span>eth0
DEVICE<span class="token operator">=</span>eth0
IPADDR<span class="token operator">=</span>192.168.10.6
PREFIX<span class="token operator">=</span>24
GATEWAY<span class="token operator">=</span>192.168.10.200
ONBOOT<span class="token operator">=</span>yes
<span class="token punctuation">[</span>10:57:13 root@internet ~<span class="token punctuation">]</span>$ route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         192.168.10.200  0.0.0.0         UG    100    0        0 eth0
192.168.10.0    0.0.0.0         255.255.255.0   U     100    0        0 eth0

<span class="token comment" spellcheck="true">#4 router网络配置</span>
<span class="token comment" spellcheck="true">##开启ip_forward</span>
<span class="token punctuation">[</span>10:50:21 root@router ~<span class="token punctuation">]</span>$ <span class="token keyword">echo</span> <span class="token string">'net.ipv4.ip_forward=1'</span> <span class="token operator">>></span>/etc/sysctl.conf 
<span class="token punctuation">[</span>10:59:39 root@router ~<span class="token punctuation">]</span>$ sysctl -p
net.ipv4.ip_forward <span class="token operator">=</span> 1
<span class="token punctuation">[</span>11:11:57 root@router netplan<span class="token punctuation">]</span>$ <span class="token function">cat</span> 00-installer-config.yaml 
<span class="token comment" spellcheck="true"># This is the network config written by 'subiquity'</span>
network: 
  version: 2 
  renderer: networkd
  ethernets:
    eth0:
      addresses:
        - 10.0.0.200/24
      gateway4: 10.0.0.2
      nameservers:
        addresses: <span class="token punctuation">[</span>180.76.76.76, 114.114.114.114<span class="token punctuation">]</span>
    eth1:
      addresses:
        - 192.168.10.200/24
<span class="token punctuation">[</span>11:12:00 root@router netplan<span class="token punctuation">]</span>$ netplan apply
<span class="token comment" spellcheck="true">##在eth0上添加一个VIP</span>
<span class="token punctuation">[</span>16:37:22 root@router ~<span class="token punctuation">]</span>$ ip a a 172.16.0.200/24 dev eth0 label eth0:1
<span class="token punctuation">[</span>16:37:26 root@router ~<span class="token punctuation">]</span>$ <span class="token function">ifconfig</span> 
eth0: flags<span class="token operator">=</span>4163<span class="token operator">&lt;</span>UP,BROADCAST,RUNNING,MULTICAST<span class="token operator">></span>  mtu 1500
        inet 10.0.0.200  netmask 255.255.255.0  broadcast 10.0.0.255
        inet6 fe80::20c:29ff:fedb:8e62  prefixlen 64  scopeid 0x20<span class="token operator">&lt;</span>link<span class="token operator">></span>
        ether 00:0c:29:db:8e:62  txqueuelen 1000  <span class="token punctuation">(</span>Ethernet<span class="token punctuation">)</span>
        RX packets 9242  bytes 5198530 <span class="token punctuation">(</span>5.1 MB<span class="token punctuation">)</span>
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 6292  bytes 472480 <span class="token punctuation">(</span>472.4 KB<span class="token punctuation">)</span>
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

eth0:1: flags<span class="token operator">=</span>4163<span class="token operator">&lt;</span>UP,BROADCAST,RUNNING,MULTICAST<span class="token operator">></span>  mtu 1500
        inet 172.16.0.200  netmask 255.255.255.0  broadcast 0.0.0.0
        ether 00:0c:29:db:8e:62  txqueuelen 1000  <span class="token punctuation">(</span>Ethernet<span class="token punctuation">)</span>

eth1: flags<span class="token operator">=</span>4163<span class="token operator">&lt;</span>UP,BROADCAST,RUNNING,MULTICAST<span class="token operator">></span>  mtu 1500
        inet 192.168.10.200  netmask 255.255.255.0  broadcast 192.168.10.255
        inet6 fe80::20c:29ff:fedb:8e6c  prefixlen 64  scopeid 0x20<span class="token operator">&lt;</span>link<span class="token operator">></span>
        ether 00:0c:29:db:8e:6c  txqueuelen 1000  <span class="token punctuation">(</span>Ethernet<span class="token punctuation">)</span>
        RX packets 969  bytes 77498 <span class="token punctuation">(</span>77.4 KB<span class="token punctuation">)</span>
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 599  bytes 73578 <span class="token punctuation">(</span>73.5 KB<span class="token punctuation">)</span>
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

lo: flags<span class="token operator">=</span>73<span class="token operator">&lt;</span>UP,LOOPBACK,RUNNING<span class="token operator">></span>  mtu 65536
        inet 127.0.0.1  netmask 255.0.0.0
        inet6 ::1  prefixlen 128  scopeid 0x10<span class="token operator">&lt;</span>host<span class="token operator">></span>
        loop  txqueuelen 1000  <span class="token punctuation">(</span>Local Loopback<span class="token punctuation">)</span>
        RX packets 1333  bytes 97114 <span class="token punctuation">(</span>97.1 KB<span class="token punctuation">)</span>
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 1333  bytes 97114 <span class="token punctuation">(</span>97.1 KB<span class="token punctuation">)</span>
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
<span class="token comment" spellcheck="true">##测试网络通不通</span>
<span class="token punctuation">[</span>11:14:18 root@router ~<span class="token punctuation">]</span>$ curl 10.0.0.7
web1
<span class="token punctuation">[</span>11:14:26 root@router ~<span class="token punctuation">]</span>$ curl 10.0.0.17
web2
<span class="token punctuation">[</span>11:14:28 root@router ~<span class="token punctuation">]</span>$ <span class="token function">ping</span> 192.168.10.6
PING 192.168.10.6 <span class="token punctuation">(</span>192.168.10.6<span class="token punctuation">)</span> 56<span class="token punctuation">(</span>84<span class="token punctuation">)</span> bytes of data.
64 bytes from 192.168.10.6: icmp_seq<span class="token operator">=</span>1 ttl<span class="token operator">=</span>64 time<span class="token operator">=</span>0.526 ms
64 bytes from 192.168.10.6: icmp_seq<span class="token operator">=</span>2 ttl<span class="token operator">=</span>64 time<span class="token operator">=</span>0.733 ms
64 bytes from 192.168.10.6: icmp_seq<span class="token operator">=</span>3 ttl<span class="token operator">=</span>64 time<span class="token operator">=</span>0.924 ms


<span class="token comment" spellcheck="true">#5 LVS服务器的网络配置</span>
<span class="token punctuation">[</span>11:28:20 root@LVS network-scripts<span class="token punctuation">]</span>$ <span class="token function">vi</span> ifcfg-eth0
BOOTPROTO<span class="token operator">=</span>static
NAME<span class="token operator">=</span>eth0
DEVICE<span class="token operator">=</span>eth0
IPADDR<span class="token operator">=</span>10.0.0.8
PREFIX<span class="token operator">=</span>24
GATEWAY<span class="token operator">=</span>10.0.0.200
ONBOOT<span class="token operator">=</span>yes
<span class="token punctuation">[</span>11:30:03 root@LVS network-scripts<span class="token punctuation">]</span>$ nmcli connection reload
<span class="token punctuation">[</span>11:30:20 root@LVS network-scripts<span class="token punctuation">]</span>$ nmcli connection up eth0
<span class="token punctuation">[</span>11:29:53 root@LVS network-scripts<span class="token punctuation">]</span>$ route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         10.0.0.2        0.0.0.0         UG    100    0        0 eth0
10.0.0.0        0.0.0.0         255.255.255.0   U     100    0        0 eth0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2 后端RS的LVS配置</p>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">[</span>16:55:48 root@web1 ~<span class="token punctuation">]</span>$ <span class="token function">cat</span> lvs_DR_RS.sh
<span class="token comment" spellcheck="true">#!/bin/bash</span>
<span class="token comment" spellcheck="true">#</span>
<span class="token comment" spellcheck="true">#***********************************************************</span>
<span class="token comment" spellcheck="true">#Author:            yanli</span>
<span class="token comment" spellcheck="true">#url:               www.yanlinux.cn</span>
<span class="token comment" spellcheck="true">#Date:              2022-10-29</span>
<span class="token comment" spellcheck="true">#FileName:          lvs_DR_RS.sh</span>
<span class="token comment" spellcheck="true">#Description:        </span>
<span class="token comment" spellcheck="true">#***********************************************************</span>
<span class="token function">read</span> -p <span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token keyword">echo</span> -e '\033<span class="token punctuation">[</span>1<span class="token punctuation">;</span>32m请输入要设置的VIP地址：\033<span class="token punctuation">[</span>0m'<span class="token variable">)</span></span>"</span> vip
mask<span class="token operator">=</span><span class="token string">'255.255.255.255'</span>
dev<span class="token operator">=</span>lo:1

<span class="token keyword">case</span> <span class="token variable">$1</span> <span class="token keyword">in</span>
start<span class="token punctuation">)</span>
    <span class="token keyword">echo</span> 1 <span class="token operator">></span> /proc/sys/net/ipv4/conf/all/arp_ignore
    <span class="token keyword">echo</span> 1 <span class="token operator">></span> /proc/sys/net/ipv4/conf/lo/arp_ignore
    <span class="token keyword">echo</span> 2 <span class="token operator">></span> /proc/sys/net/ipv4/conf/all/arp_announce
    <span class="token keyword">echo</span> 2 <span class="token operator">></span> /proc/sys/net/ipv4/conf/lo/arp_announce
    <span class="token function">ifconfig</span> <span class="token variable">$dev</span> <span class="token variable">$vip</span> netmask <span class="token variable">$mask</span>
    <span class="token keyword">echo</span> <span class="token string">"The RS Server is Ready!"</span>
    <span class="token punctuation">;</span><span class="token punctuation">;</span>
stop<span class="token punctuation">)</span>
    <span class="token function">ifconfig</span> <span class="token variable">$dev</span> down
    <span class="token keyword">echo</span> 0 <span class="token operator">></span> /proc/sys/net/ipv4/conf/all/arp_ignore
    <span class="token keyword">echo</span> 0 <span class="token operator">></span> /proc/sys/net/ipv4/conf/lo/arp_ignore
    <span class="token keyword">echo</span> 0 <span class="token operator">></span> /proc/sys/net/ipv4/conf/all/arp_announce
    <span class="token keyword">echo</span> 0 <span class="token operator">></span> /proc/sys/net/ipv4/conf/lo/arp_announce
    <span class="token keyword">echo</span> <span class="token string">"The RS Server is Canceled!"</span>
    <span class="token punctuation">;</span><span class="token punctuation">;</span>
*<span class="token punctuation">)</span>
    <span class="token keyword">echo</span> <span class="token string">"Usage: <span class="token variable"><span class="token variable">$(</span><span class="token function">basename</span> $0<span class="token variable">)</span></span> start|stop"</span>
    <span class="token keyword">exit</span> 1
    <span class="token punctuation">;</span><span class="token punctuation">;</span>
esac

<span class="token comment" spellcheck="true">#在两个RS服务器上运行这个脚本</span>
<span class="token punctuation">[</span>16:56:35 root@web1 ~<span class="token punctuation">]</span>$ sh lvs_DR_RS.sh start
请输入要设置的VIP地址：172.16.0.100
The RS Server is Ready<span class="token operator">!</span>
<span class="token punctuation">[</span>16:58:15 root@web2 ~<span class="token punctuation">]</span>$ sh lvs_DR_RS.sh start
请输入要设置的VIP地址：172.16.0.100
The RS Server is Ready<span class="token operator">!</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>3 LVS服务器配置</p>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">[</span>17:03:15 root@LVS ~<span class="token punctuation">]</span>$ <span class="token function">cat</span> lvs_DR_VS.sh 
<span class="token comment" spellcheck="true">#!/bin/bash</span>
<span class="token comment" spellcheck="true">#</span>
<span class="token comment" spellcheck="true">#***********************************************************</span>
<span class="token comment" spellcheck="true">#Author:            yanli</span>
<span class="token comment" spellcheck="true">#Date:              2022-10-29</span>
<span class="token comment" spellcheck="true">#FileName:          lvs_DR_VS.sh</span>
<span class="token comment" spellcheck="true">#Description:        </span>
<span class="token comment" spellcheck="true">#***********************************************************</span>
<span class="token function">read</span> -p <span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token keyword">echo</span> -e '\033<span class="token punctuation">[</span>1<span class="token punctuation">;</span>32m请输入要设置的VIP地址：\033<span class="token punctuation">[</span>0m'<span class="token variable">)</span></span>"</span> vip
iface<span class="token operator">=</span><span class="token string">'lo:1'</span>
mask<span class="token operator">=</span><span class="token string">'255.255.255.255'</span>
port<span class="token operator">=</span><span class="token string">'80'</span>
rs1<span class="token operator">=</span><span class="token string">'10.0.0.7'</span>
rs2<span class="token operator">=</span><span class="token string">'10.0.0.17'</span>
scheduler<span class="token operator">=</span><span class="token string">'wrr'</span>
type<span class="token operator">=</span><span class="token string">'-g'</span>
rpm -q ipvsadm <span class="token operator">&amp;</span><span class="token operator">></span> /dev/null <span class="token operator">||</span> yum -y <span class="token function">install</span> ipvsadm <span class="token operator">&amp;</span><span class="token operator">></span> /dev/null

<span class="token keyword">case</span> <span class="token variable">$1</span> <span class="token keyword">in</span>
start<span class="token punctuation">)</span>
    <span class="token function">ifconfig</span> <span class="token variable">$iface</span> <span class="token variable">$vip</span> netmask <span class="token variable">$mask</span> <span class="token comment" spellcheck="true">#broadcast $vip up</span>
    iptables -F

    ipvsadm -A -t <span class="token variable">${vip}</span><span class="token keyword">:</span><span class="token variable">${port}</span> -s <span class="token variable">$scheduler</span>
    ipvsadm -a -t <span class="token variable">${vip}</span><span class="token keyword">:</span><span class="token variable">${port}</span> -r <span class="token variable">${rs1}</span> <span class="token variable">$type</span> -w 1
    ipvsadm -a -t <span class="token variable">${vip}</span><span class="token keyword">:</span><span class="token variable">${port}</span> -r <span class="token variable">${rs2}</span> <span class="token variable">$type</span> -w 1
    <span class="token keyword">echo</span> <span class="token string">"The VS Server is Ready!"</span>
    <span class="token punctuation">;</span><span class="token punctuation">;</span>
stop<span class="token punctuation">)</span>
    ipvsadm -C
    <span class="token function">ifconfig</span> <span class="token variable">$iface</span> down
    <span class="token keyword">echo</span> <span class="token string">"The VS Server is Canceled!"</span>
    <span class="token punctuation">;</span><span class="token punctuation">;</span>
*<span class="token punctuation">)</span>
    <span class="token keyword">echo</span> <span class="token string">"Usage: <span class="token variable"><span class="token variable">$(</span><span class="token function">basename</span> $0<span class="token variable">)</span></span> start|stop"</span>
    <span class="token keyword">exit</span> 1
    <span class="token punctuation">;</span><span class="token punctuation">;</span>
esac

<span class="token comment" spellcheck="true">#运行改脚本</span>
<span class="token punctuation">[</span>17:04:26 root@LVS ~<span class="token punctuation">]</span>$ sh lvs_DR_VS.sh start
<span class="token punctuation">[</span>17:04:59 root@LVS ~<span class="token punctuation">]</span>$ ipvsadm -Ln
IP Virtual Server version 1.2.1 <span class="token punctuation">(</span>size<span class="token operator">=</span>4096<span class="token punctuation">)</span>
Prot LocalAddress:Port Scheduler Flags
  -<span class="token operator">></span> RemoteAddress:Port           Forward Weight ActiveConn InActConn
TCP  172.16.0.100:80 wrr
  -<span class="token operator">></span> 10.0.0.7:80                  Route   1      0          0         
  -<span class="token operator">></span> 10.0.0.17:80                 Route   1      0          0


<span class="token comment" spellcheck="true">#internet测试</span>
<span class="token punctuation">[</span>17:02:57 root@internet ~<span class="token punctuation">]</span>$ <span class="token keyword">while</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token keyword">do</span> curl 172.16.0.100<span class="token punctuation">;</span><span class="token function">sleep</span> 1<span class="token punctuation">;</span><span class="token keyword">done</span>
web2
web1
web2
web1
web2
web1
web2
web1
web2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="4-web-http协议通信过程，相关技术术语总结。"><a href="#4-web-http协议通信过程，相关技术术语总结。" class="headerlink" title="4 web http协议通信过程，相关技术术语总结。"></a>4 web http协议通信过程，相关技术术语总结。</h2><h3 id="4-1-http协议通信过程"><a href="#4-1-http协议通信过程" class="headerlink" title="4.1 http协议通信过程"></a>4.1 http协议通信过程</h3><ul>
<li>建立TCP连接：在HTTP工作开始之前，web浏览器通过网络与服务器通过tcp建立连接，一般连接的端口号为80</li>
<li>web浏览器向服务器发送请求命令：GET/sample/heelo.jsp HTTP/1.1</li>
<li>web浏览器发送请求头信息：浏览器发送请求命令后，还要以头信息的形式向服务器发送一些信息，之后浏览器再发送一行空白行来通知服务器，它已经结束了头信息的发送</li>
<li>web服务器应答：HTTP/1.1 200 OK</li>
<li>web服务器发送应答头信息：像浏览器发送自身信息那样，服务器也会随同应答向客户端发送关于它自己的数据及请求的文档</li>
<li>web服务器想浏览器发送数据：发送头信息后，会发送一空白行表示头信息完毕，接着，就以Content-Type应答头信息所描述的格式发送客户端请求的实际数据</li>
<li>web服务器关闭连接：一般情况下，一旦web服务器向浏览器发送了请求的数据，就会关闭TCP连接。若浏览器或者服务器在头信息中加入了<code>Connection:keep-alive</code>，TCP连接在发送后仍将以打开状态，于是，浏览器可以继续通过相同的连接发送请求。</li>
</ul>
<h3 id="4-2-相关技术术语"><a href="#4-2-相关技术术语" class="headerlink" title="4.2 相关技术术语"></a>4.2 相关技术术语</h3><h4 id="4-2-1-WEB开发语言"><a href="#4-2-1-WEB开发语言" class="headerlink" title="4.2.1 WEB开发语言"></a>4.2.1 WEB开发语言</h4><ul>
<li><code>html</code>：<code>Hyper Text Markup Language</code>超文本标记语言，编程语言，主要负责<strong>实现页面的结构</strong></li>
<li><code>css</code>：<code>Cascading Style Sheet</code> 层叠样式表， 定义了如何显示（装扮） HTML 元素，比如：字体大小和颜色属性等。样式通常保存在外部的 .css 文件中,用于存放一些HTML文件的公共属性,从而通过仅编辑一个简单的 CSS 文档，可以同时改变站点中所有页面的<strong>布局和外观</strong>。</li>
<li><code>javascript</code>：实现<strong>网页的动画效果</strong>，但是属于静态资源</li>
</ul>
<h4 id="4-2-2-MIME"><a href="#4-2-2-MIME" class="headerlink" title="4.2.2 MIME"></a>4.2.2 MIME</h4><p><code>MIME</code> : <code>Multipurpose Internet Mail Extensions</code>多用途互联网邮件扩展</p>
<p>MIME 消息能包含文本、图像、音频、视频以及其他应用程序专用的数据。</p>
<h4 id="4-2-3-URI和URL"><a href="#4-2-3-URI和URL" class="headerlink" title="4.2.3 URI和URL"></a>4.2.3 URI和URL</h4><ul>
<li><p><code>URI</code>： <code>Uniform Resource Identifier</code> 统一资源标识，分为<code>URL</code> 和 <code>URN</code></p>
</li>
<li><p><code>URN</code>：<code>Uniform Resource Naming</code>，统一资源命名</p>
</li>
<li><p>示例： P2P下载使用的磁力链接是URN的一种实现magnet:?xt=urn:btih:660557A6890EF888666</p>
</li>
<li><p><code>URL</code>：<code>Uniform Resorce Locator</code>，统一资源定位符，用于描述某服务器某特定资源位置</p>
</li>
</ul>
<p>两者区别：<code>URN</code>如同一个人的名称，而<code>URL</code>代表一个人的住址。换言之，<code>URN</code>定义<strong>某事物的身份</strong>，而<code>URL</code>提供<strong>查找该事物的方法</strong>。<code>URN</code>仅用于命名，而不指定地址</p>
<h4 id="4-2-4-网站访问量"><a href="#4-2-4-网站访问量" class="headerlink" title="4.2.4 网站访问量"></a>4.2.4 网站访问量</h4><p><strong>网站访问量统计的重要指标</strong></p>
<ul>
<li><strong>IP(独立IP)</strong>：即<code>Internet Protocol</code>,指独立IP数。一天内来自相同客户机IP 地址只计算一次，记录远程客户机IP地址的计算机访问网站的次数，是衡量网站流量的重要指标</li>
<li><strong>PV(访问量)</strong>： 即<code>Page View</code>, 页面浏览量或点击量，用户每次刷新即被计算一次，PV反映的是浏览某网站的页面数，PV与来访者的数量成正比，PV并不是页面的来访者数量，而是网站被访问的页面数量</li>
<li><strong>UV(独立访客)</strong>：即<code>Unique Visitor</code>,访问网站的一台电脑为一个访客。一天内相同的客户端只被计算一次。可以理解成访问某网站的电脑的数量。网站判断来访电脑的身份是通过<strong>cookies</strong>实现的。如果更换了IP后但不清除cookies，再访问相同网站，该网站的统计中UV数是不变的</li>
</ul>
<p><strong>网站访问量</strong></p>
<ul>
<li><code>QPS</code>：<code>request per second</code>，每秒请求数</li>
<li><code>PV</code>，<code>QPS</code>和并发连接数换算公式<ul>
<li><code>QPS</code>= <code>PV</code> <code>*</code> 页面衍生连接次数/ 统计时间（86400）</li>
<li>并发连接数 =QPS * http平均响应时间</li>
</ul>
</li>
<li>峰值时间：每天80%的访问集中在20%的时间里，这20%时间为峰值时间</li>
<li>峰值时间每秒请求数(QPS)=( 总PV数 <em>页面衍生连接次数）</em>80% ) / ( 每天秒数 * 20% )</li>
</ul>
<h2 id="5-总结网络IO模型和nginx架构。"><a href="#5-总结网络IO模型和nginx架构。" class="headerlink" title="5 总结网络IO模型和nginx架构。"></a>5 总结网络IO模型和nginx架构。</h2><h3 id="5-1-网络IO模型"><a href="#5-1-网络IO模型" class="headerlink" title="5.1 网络IO模型"></a>5.1 网络IO模型</h3><h4 id="5-1-1-阻塞型IO模型-blocking-IO"><a href="#5-1-1-阻塞型IO模型-blocking-IO" class="headerlink" title="5.1.1 阻塞型IO模型(blocking IO)"></a>5.1.1 阻塞型IO模型(blocking IO)</h4><p>阻塞IO模型时最简单的I/O模型。</p>
<p>在应用调用<code>recvfrom</code>读取数据时，系统调用直到kernel将数据包准备好且拷贝到应用进程缓冲区或者发送错误时才返回，在此期间一直处于等待状态，进程在这段时间都是被阻塞的。</p>
<p><img src="https://yanlinuxblog.oss-cn-hangzhou.aliyuncs.com/img/image-20221108232510795.png" alt=""></p>
<h4 id="5-1-2-非阻塞型I-O模型-nonblocking-IO"><a href="#5-1-2-非阻塞型I-O模型-nonblocking-IO" class="headerlink" title="5.1.2 非阻塞型I/O模型(nonblocking IO)"></a>5.1.2 非阻塞型I/O模型(nonblocking IO)</h4><p>非阻塞型IO是在应用调用recvfrom读取数据，如果该缓冲区没有数据的话，就会直接返回一个<code>EWOULBLOCK</code>错误，不会让应用一直等待。在没有数据的时候会即刻返回错误标识，那也意味着如果应用要读取数据就需要不断的调用recvfrom请求，直到读取到它数据要的数据为止。俗话说就是当应用发起读取数据申请的时候，若内核数据没有准备好会即刻告诉应用，不会让应用在那里等待。</p>
<p><img src="https://yanlinuxblog.oss-cn-hangzhou.aliyuncs.com/img/image-20221110111935572.png" alt=""></p>
<h4 id="5-1-3-I-O多路复用模型（I-O-multiplexing）"><a href="#5-1-3-I-O多路复用模型（I-O-multiplexing）" class="headerlink" title="5.1.3 I/O多路复用模型（I/O multiplexing）"></a>5.1.3 I/O多路复用模型（I/O multiplexing）</h4><p>进程通过将一个或多个<code>fd</code>传递给<code>select</code>，阻塞在<code>select</code>操作上，<code>select</code>帮我们侦测多个<code>fd</code>是否准备就绪，当有<code>fd</code>准备就绪时，<code>select</code>返回数据可读状态，应用程序再调用<code>recvfrom</code>读取数据。</p>
<p>复用IO的基本思路就是通过<code>select</code>或<code>poll</code>、<code>epoll</code>来监控多<code>fd</code> ，不断的轮询所负责的所有socket，当某个socket有数据到达了，就通知用户进程。来达到不必为每个fd创建一个对应的监控线程，从而减少线程资源创建的目的。</p>
<p><img src="https://yanlinuxblog.oss-cn-hangzhou.aliyuncs.com/img/image-20221110115154897.png" alt=""></p>
<h4 id="5-1-4-信号驱动IO模型（signal-driven-IO）"><a href="#5-1-4-信号驱动IO模型（signal-driven-IO）" class="headerlink" title="5.1.4 信号驱动IO模型（signal-driven IO）"></a>5.1.4 信号驱动IO模型（signal-driven IO）</h4><p>首先开启套接口信号驱动IO功能，并通过系统调用sigaction执行一个信号处理函数，此时请求即刻返回，当数据准备就绪时，就生成对应进程的SIGIO信号，通过信号回调通知应用线程调用recvfrom来读取数据。</p>
<p> IO复用模型里面的select虽然可以监控多个fd了，但select其实现的本质上还是通过不断的轮询fd来监控数据状态， 因为大部分轮询请求其实都是无效的，所以信号驱动IO意在通过这种建立信号关联的方式，实现了发出请求后只需要等待数据就绪的通知即可，这样就可以避免大量无效的数据状态轮询操作。</p>
<p><img src="https://yanlinuxblog.oss-cn-hangzhou.aliyuncs.com/img/image-20221110122130300.png" alt=""></p>
<h4 id="5-1-5-异步IO（asynchronous-IO）"><a href="#5-1-5-异步IO（asynchronous-IO）" class="headerlink" title="5.1.5 异步IO（asynchronous IO）"></a>5.1.5 异步IO（asynchronous IO）</h4><p>应用告知内核启动某个操作，并让内核在整个操作完成之后，通知应用，这种模型与信号驱动模型的主要区别在于，信号驱动IO只是由内核通知我们合适可以开始下一个IO操作，而异步IO模型是由内核通知我们操作什么时候完成。</p>
<p>异步IO的优化思路是解决了应用程序需要先后发送询问请求、发送接收数据请求两个阶段的模式，在异步IO的模式下，只需要向内核发送一次请求就可以完成状态询问和数拷贝的所有操作。</p>
<p><img src="https://yanlinuxblog.oss-cn-hangzhou.aliyuncs.com/img/image-20221110122947782.png" alt=""></p>
<h3 id="5-2-nginx架构"><a href="#5-2-nginx架构" class="headerlink" title="5.2 nginx架构"></a>5.2 nginx架构</h3><p><img src="https://yanlinuxblog.oss-cn-hangzhou.aliyuncs.com/img/image-20221110124018568.png" alt=""></p>
<p><strong>一个master进程，可生成一个或多个worker进程</strong></p>
<ul>
<li>master：负责加载分析配置文件、管理worker进程、平滑升级、…</li>
<li>worker：处理并响应用户请求</li>
</ul>
<p>一个master有多个worker，每个worker可响应n个请求，每个worker有核心模块core和外围的诸多模块modules组成</p>
<p><strong>nginx大致架构就是：</strong></p>
<ul>
<li>1.Nginx启动后，会产生一个主进程，主进程执行一系列的工作后会产生一个或者多个工作进程；</li>
<li>2.在客户端请求动态站点的过程中，Nginx服务器还涉及和后端服务器的通信。Nginx将接收到的Web请求通过代理转发到后端服务器，由后端服务器进行数据处理和组织；</li>
<li>3.Nginx为了提高对请求的响应效率，降低网络压力，采用了缓存机制，将历史应答数据缓存到本地。保障对缓存文件的快速访问</li>
</ul>
<h2 id="6-nginx总结核心配置和优化。"><a href="#6-nginx总结核心配置和优化。" class="headerlink" title="6 nginx总结核心配置和优化。"></a>6 nginx总结核心配置和优化。</h2><h3 id="6-1-全局配置优化项"><a href="#6-1-全局配置优化项" class="headerlink" title="6.1 全局配置优化项"></a>6.1 全局配置优化项</h3><pre class="line-numbers language-bash"><code class="language-bash">user nginx nginx<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">#启动Nginx工作进程的用户和组,在创建nginx账号的时候，在所有集群上最好指定uid，实现所有集群上的对应关系</span>

worker_processes <span class="token punctuation">[</span>number <span class="token operator">|</span> auto<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">#启动Nginx工作进程的数量,一般设为和CPU核心数相同。为了防止不同机器CPU核数不同，若写死工作进程数的话，会导致有的机器资源浪费，所以可以不写死进程数，写上auto来自动匹配机器的CPU核数。</span>

worker_cpu_affinity 00000001 00000010 00000100 00001000 <span class="token operator">|</span> auto <span class="token punctuation">;</span> <span class="token comment" spellcheck="true">#将Nginx工作进程绑定到指定的CPU核心，默认Nginx是不进行进程绑定的，绑定并不是意味着当前nginx进程独占以一核心CPU，但是可以保证此进程不会运行在其他核心上，这就极大减少了nginx的工作进程在不同的cpu核心上的来回跳转，减少了CPU对进程的资源分配与回收以及内存管理等，因此可以有效的提升nginx服务器的性能。</span>
CPU MASK: 00000001：0号CPU
          00000010：1号CPU
          10000000：7号CPU
<span class="token comment" spellcheck="true">#示例:</span>
worker_cpu_affinity 0001 0010 0100 1000<span class="token punctuation">;</span>第0号---第3号CPU

worker_priority 0<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">#工作进程优先级，-20~20(19)</span>
worker_rlimit_nofile 65536<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">#所有worker进程能打开的文件数量上限,包括:Nginx的所有连接（例如与代理服务器的连接等），而不仅仅是与客户端的连接,另一个考虑因素是实际的并发连接数不能超过系统级别的最大打开文件数的限制.最好与ulimit -n 或者limits.conf的值保持一致。内核中也要改</span>

events <span class="token punctuation">{</span>
    worker_connections 65536<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">#设置单个工作进程的最大并发连接数</span>
    accept_mutex on<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">#on为同一时刻一个请求轮流由work进程处理,而防止被同时唤醒所有worker,避免多个睡眠进程被唤醒的设置，默认为off，新请求会唤醒所有worker进程,此过程也称为"惊群"，因此nginx刚安装完以后要进行适当的优化。建议设置为on</span>
    multi_accept on<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">#on时Nginx服务器的每个工作进程可以同时接受多个新的网络连接，此指令默认为off，即默认为一个工作进程只能一次接受一个新的网络连接，打开后几个同时接受多个。建议设置为on</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="6-2-http配置及优化"><a href="#6-2-http配置及优化" class="headerlink" title="6.2 http配置及优化"></a>6.2 http配置及优化</h3><pre class="line-numbers language-bash"><code class="language-bash">http <span class="token punctuation">{</span>
    include mime.types<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">#导入支持的文件类型,是相对于/apps/nginx/conf的目录</span>
    default_type application/octet-stream<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">#除mime.types中文件类型外,设置其它文件默认类型，访问其它类型时会提示下载不匹配的类型文件</span>

<span class="token comment" spellcheck="true">#日志配置部分</span>
    <span class="token comment" spellcheck="true">#log_format main '$remote_addr - $remote_user [$time_local] "$request" '</span>
    <span class="token comment" spellcheck="true">#                '$status $body_bytes_sent "$http_referer" '</span>
    <span class="token comment" spellcheck="true">#                '"$http_user_agent" "$http_x_forwarded_for"';</span>
    <span class="token comment" spellcheck="true">#access_log logs/access.log main;</span>

<span class="token comment" spellcheck="true">#自定义优化参数</span>
    sendfile on<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">#tcp_nopush on; #在开启了sendfile的情况下，合并请求后统一发送给客户端,必须开启sendfile</span>
    <span class="token comment" spellcheck="true">#tcp_nodelay off; #在开启了keepalived模式下的连接是否启用TCP_NODELAY选项，当为off时，延迟0.2s发送，默认On时，不延迟发送，立即发送用户响应报文。</span>

    <span class="token comment" spellcheck="true">#keepalive_timeout 0;</span>
    keepalive_timeout 65 65<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">#设置会话保持时间,第二个值为响应首部:keep-Alived:timeout=65,可以和第一个值不同</span>
    <span class="token comment" spellcheck="true">#gzip on; #开启文件压缩</span>

    server <span class="token punctuation">{</span>
        listen 80<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">#设置监听地址和端口</span>
        server_name localhost<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">#设置server name，可以以空格隔开写多个并支持正则表达式，如:*.magedu.com www.magedu.* ~^www\d+\.magedu\.com$ default_server</span>
        <span class="token comment" spellcheck="true">#charset koi8-r; #设置编码格式，默认是俄语格式，建议改为utf-8</span>
        <span class="token comment" spellcheck="true">#access_log logs/host.access.log main;</span>
        location / <span class="token punctuation">{</span>
            root html<span class="token punctuation">;</span>
            index index.html index.htm<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">#error_page 404 /404.html;</span>
        <span class="token comment" spellcheck="true"># redirect server error pages to the static page /50x.html</span>
        <span class="token comment" spellcheck="true">#</span>
        error_page 500 502 503 504 /50x.html<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">#定义错误页面</span>
        location <span class="token operator">=</span> /50x.html <span class="token punctuation">{</span>
            root html<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true"># proxy the PHP scripts to Apache listening on 127.0.0.1:80</span>
        <span class="token comment" spellcheck="true">#</span>
        <span class="token comment" spellcheck="true">#location ~ \.php$ { #以http的方式转发php请求到指定web服务器</span>
        <span class="token comment" spellcheck="true">#     proxy_pass http://127.0.0.1;</span>
        <span class="token comment" spellcheck="true">#}</span>

        <span class="token comment" spellcheck="true"># pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000</span>
        <span class="token comment" spellcheck="true">#</span>
        <span class="token comment" spellcheck="true">#location ~ \.php$ { #以fastcgi的方式转发php请求到php处理</span>
        <span class="token comment" spellcheck="true">#     root html;</span>
        <span class="token comment" spellcheck="true">#     fastcgi_pass 127.0.0.1:9000;</span>
        <span class="token comment" spellcheck="true">#      fastcgi_index index.php;</span>
        <span class="token comment" spellcheck="true">#     fastcgi_param SCRIPT_FILENAME /scripts$fastcgi_script_name;</span>
        <span class="token comment" spellcheck="true">#     include fastcgi_params;</span>
        <span class="token comment" spellcheck="true">#}</span>

        <span class="token comment" spellcheck="true"># deny access to .htaccess files, if Apache's document root</span>
        <span class="token comment" spellcheck="true"># concurs with nginx's one</span>
        <span class="token comment" spellcheck="true">#</span>
        <span class="token comment" spellcheck="true">#location ~ /\.ht { #拒绝web形式访问指定文件，如很多的网站都是通过.htaccess文件来改变自己的重定向等功能。</span>
        <span class="token comment" spellcheck="true">#     deny all;</span>
        <span class="token comment" spellcheck="true">#}</span>
        location ~ /passwd.html <span class="token punctuation">{</span>
        deny all<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true"># another virtual host using mix of IP-, name-, and port-based configuration</span>
    <span class="token comment" spellcheck="true">#</span>
    <span class="token comment" spellcheck="true">#server { #自定义虚拟server</span>
    <span class="token comment" spellcheck="true">#     listen 8000;</span>
    <span class="token comment" spellcheck="true">#     listen somename:8080;</span>
    <span class="token comment" spellcheck="true">#     server_name somename alias another.alias;</span>

    <span class="token comment" spellcheck="true">#     location / {</span>
    <span class="token comment" spellcheck="true">#         root html;</span>
    <span class="token comment" spellcheck="true">#         index index.html index.htm; #指定默认网页文件，此指令由ngx_http_index_module模块提供</span>

    <span class="token comment" spellcheck="true">#     }</span>
    <span class="token comment" spellcheck="true">#}</span>

    <span class="token comment" spellcheck="true"># HTTPS server</span>
    <span class="token comment" spellcheck="true">#</span>
    <span class="token comment" spellcheck="true">#server { #https服务器配置</span>
    <span class="token comment" spellcheck="true">#     listen 443 ssl;</span>
    <span class="token comment" spellcheck="true">#      server_name localhost;</span>

    <span class="token comment" spellcheck="true">#     ssl_certificate cert.pem;</span>
    <span class="token comment" spellcheck="true">#     ssl_certificate_key cert.key;</span>

    <span class="token comment" spellcheck="true">#     ssl_session_cache shared:SSL:1m;</span>
    <span class="token comment" spellcheck="true">#     ssl_session_timeout 5m;</span>

    <span class="token comment" spellcheck="true">#     ssl_ciphers HIGH:!aNULL:!MD5;</span>
    <span class="token comment" spellcheck="true">#     ssl_prefer_server_ciphers on;</span>

    <span class="token comment" spellcheck="true">#     location / {</span>
    <span class="token comment" spellcheck="true">#         root html;</span>
    <span class="token comment" spellcheck="true">#          index index.html index.htm;</span>
    <span class="token comment" spellcheck="true">#     }</span>
    <span class="token comment" spellcheck="true">#}</span>

<span class="token comment" spellcheck="true">#是否在响应报文的Server首部显示nginx版本,建议设置成o</span>
server_tokens on <span class="token operator">|</span> off <span class="token operator">|</span> build <span class="token operator">|</span> string<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="6-3-开启压缩功能"><a href="#6-3-开启压缩功能" class="headerlink" title="6.3 开启压缩功能"></a>6.3 开启压缩功能</h3><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#启用或禁用gzip压缩，默认关闭</span>
<span class="token function">gzip</span> on <span class="token operator">|</span> off<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">#压缩比由低到高从1到9，默认为1</span>
gzip_comp_level level<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">#禁用IE6 gzip功能</span>
gzip_disable <span class="token string">"MSIE [1-6]\."</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">#gzip压缩的最小文件，小于设置值的文件将不会压缩</span>
gzip_min_length 1k<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">#启用压缩功能时，协议的最小版本，默认HTTP/1.1</span>
gzip_http_version 1.0 <span class="token operator">|</span> 1.1<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">#指定Nginx服务需要向服务器申请的缓存空间的个数和大小,平台不同,默认:32 4k或者16 8k;</span>
gzip_buffers number size<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">#指明仅对哪些类型的资源执行压缩操作;默认为gzip_types text/html，不用显示指定，否则出错</span>
gzip_types mime-type <span class="token punctuation">..</span>.<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">#如果启用压缩，是否在响应报文首部插入“Vary: Accept-Encoding”,一般建议打开</span>
gzip_vary on <span class="token operator">|</span> off<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">#预压缩，即直接从磁盘找到对应文件的gz后缀的式的压缩文件返回给用户，无需消耗服务器CPU</span>
<span class="token comment" spellcheck="true">#注意: 来自于ngx_http_gzip_static_module模块</span>
gzip_static on <span class="token operator">|</span> off<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="6-4-自定义日志格式"><a href="#6-4-自定义日志格式" class="headerlink" title="6.4 自定义日志格式"></a>6.4 自定义日志格式</h3><blockquote>
<p>Nginx 的默认访问日志记录内容相对比较单一，默认的格式也不方便后期做日志统计分析，生产环境中<br>通常将nginx日志转换为json日志，然后配合使用<code>ELK</code>做日志收集,统计和分析。</p>
</blockquote>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">[</span>17:13:05 root@rocky ~<span class="token punctuation">]</span>$ <span class="token function">vi</span> /apps/nginx/conf/nginx.conf
http <span class="token punctuation">{</span>
    include       mime.types<span class="token punctuation">;</span>
    default_type  application/octet-stream<span class="token punctuation">;</span>
    log_format  testlog <span class="token string">'<span class="token variable">$remote_addr</span>  [<span class="token variable">$time_local</span>] "<span class="token variable">$request</span>" <span class="token variable">$status</span> "<span class="token variable">$http_user_agent</span>" '</span><span class="token punctuation">;</span>
    log_format  access_json <span class="token string">'{"@timestamp":"<span class="token variable">$time_iso8601</span>",'</span>
        <span class="token string">'"host":"<span class="token variable">$server_addr</span>",'</span>
        <span class="token string">'"clientip":"<span class="token variable">$remote_addr</span>",'</span>
        <span class="token string">'"size":<span class="token variable">$body_bytes_sent</span>,'</span>
        <span class="token string">'"responsetime":<span class="token variable">$request_time</span>,'</span> <span class="token comment" spellcheck="true">#总的处理时间</span>
        <span class="token string">'"upstreamtime":"<span class="token variable">$upstream_response_time</span>",'</span>
        <span class="token string">'"upstreamhost":"<span class="token variable">$upstream_addr</span>",'</span>   <span class="token comment" spellcheck="true">#后端应用服务器处理时间</span>
        <span class="token string">'"http_host":"<span class="token variable">$host</span>",'</span>
        <span class="token string">'"uri":"<span class="token variable">$uri</span>",'</span>
        <span class="token string">'"xff":"<span class="token variable">$http_x_forwarded_for</span>",'</span>
        <span class="token string">'"referer":"<span class="token variable">$http_referer</span>",'</span>
        <span class="token string">'"tcp_xff":"<span class="token variable">$proxy_protocol_addr</span>",'</span>
        <span class="token string">'"http_user_agent":"<span class="token variable">$http_user_agent</span>",'</span>
        <span class="token string">'"status":"<span class="token variable">$status</span>"}'</span><span class="token punctuation">;</span>
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>

<span class="token punctuation">[</span>17:20:25 root@rocky ~<span class="token punctuation">]</span>$ <span class="token function">vi</span> /apps/nginx/conf/conf.d/pc.conf
vhost_traffic_status_zone<span class="token punctuation">;</span>
server <span class="token punctuation">{</span>
    server_name www.yanlinux.org<span class="token punctuation">;</span>
    root /apps/nginx/html/pc<span class="token punctuation">;</span>
    access_log /apps/nginx/logs/pc-access.log testlog<span class="token punctuation">;</span>
    access_log /apps/nginx/logs/pc-access-json.log access_json<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">#此处</span>
    location /status <span class="token punctuation">{</span>
        vhost_traffic_status_display<span class="token punctuation">;</span>
        vhost_traffic_status_display_format html<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    location <span class="token operator">=</span> /nginx_status <span class="token punctuation">{</span>
        stub_status<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    location /echo <span class="token punctuation">{</span>
        <span class="token keyword">set</span> <span class="token variable">$name</span> yanli<span class="token punctuation">;</span>
        <span class="token keyword">echo</span> <span class="token variable">$name</span><span class="token punctuation">;</span>
        <span class="token keyword">set</span> <span class="token variable">$my_port</span> <span class="token variable">$server_port</span><span class="token punctuation">;</span>
        <span class="token keyword">echo</span> <span class="token variable">$my_port</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token punctuation">[</span>17:24:02 root@rocky ~<span class="token punctuation">]</span>$ <span class="token function">cat</span> /apps/nginx/logs/pc-access-json.log <span class="token operator">|</span>jq 
<span class="token punctuation">{</span>
  <span class="token string">"@timestamp"</span><span class="token keyword">:</span> <span class="token string">"2022-11-07T17:22:43+08:00"</span>,
  <span class="token string">"host"</span><span class="token keyword">:</span> <span class="token string">"10.0.0.8"</span>,
  <span class="token string">"clientip"</span><span class="token keyword">:</span> <span class="token string">"10.0.0.18"</span>,
  <span class="token string">"size"</span><span class="token keyword">:</span> 28,
  <span class="token string">"responsetime"</span><span class="token keyword">:</span> 0.000,
  <span class="token string">"upstreamtime"</span><span class="token keyword">:</span> <span class="token string">"-"</span>,
  <span class="token string">"upstreamhost"</span><span class="token keyword">:</span> <span class="token string">"-"</span>,
  <span class="token string">"http_host"</span><span class="token keyword">:</span> <span class="token string">"www.yanlinux.org"</span>,
  <span class="token string">"uri"</span><span class="token keyword">:</span> <span class="token string">"/index.html"</span>,
  <span class="token string">"xff"</span><span class="token keyword">:</span> <span class="token string">"-"</span>,
  <span class="token string">"referer"</span><span class="token keyword">:</span> <span class="token string">"-"</span>,
  <span class="token string">"tcp_xff"</span><span class="token keyword">:</span> <span class="token string">"-"</span>,
  <span class="token string">"http_user_agent"</span><span class="token keyword">:</span> <span class="token string">"curl/7.61.1"</span>,
  <span class="token string">"status"</span><span class="token keyword">:</span> <span class="token string">"200"</span>
<span class="token punctuation">}</span>
<span class="token punctuation">{</span>
  <span class="token string">"@timestamp"</span><span class="token keyword">:</span> <span class="token string">"2022-11-07T17:22:44+08:00"</span>,
  <span class="token string">"host"</span><span class="token keyword">:</span> <span class="token string">"10.0.0.8"</span>,
  <span class="token string">"clientip"</span><span class="token keyword">:</span> <span class="token string">"10.0.0.18"</span>,
  <span class="token string">"size"</span><span class="token keyword">:</span> 28,
  <span class="token string">"responsetime"</span><span class="token keyword">:</span> 0.000,
  <span class="token string">"upstreamtime"</span><span class="token keyword">:</span> <span class="token string">"-"</span>,
  <span class="token string">"upstreamhost"</span><span class="token keyword">:</span> <span class="token string">"-"</span>,
  <span class="token string">"http_host"</span><span class="token keyword">:</span> <span class="token string">"www.yanlinux.org"</span>,
  <span class="token string">"uri"</span><span class="token keyword">:</span> <span class="token string">"/index.html"</span>,
  <span class="token string">"xff"</span><span class="token keyword">:</span> <span class="token string">"-"</span>,
  <span class="token string">"referer"</span><span class="token keyword">:</span> <span class="token string">"-"</span>,
  <span class="token string">"tcp_xff"</span><span class="token keyword">:</span> <span class="token string">"-"</span>,
  <span class="token string">"http_user_agent"</span><span class="token keyword">:</span> <span class="token string">"curl/7.61.1"</span>,
  <span class="token string">"status"</span><span class="token keyword">:</span> <span class="token string">"200"</span>
<span class="token punctuation">}</span>
<span class="token punctuation">{</span>
  <span class="token string">"@timestamp"</span><span class="token keyword">:</span> <span class="token string">"2022-11-07T17:22:44+08:00"</span>,
  <span class="token string">"host"</span><span class="token keyword">:</span> <span class="token string">"10.0.0.8"</span>,
  <span class="token string">"clientip"</span><span class="token keyword">:</span> <span class="token string">"10.0.0.18"</span>,
  <span class="token string">"size"</span><span class="token keyword">:</span> 24,
  <span class="token string">"responsetime"</span><span class="token keyword">:</span> 0.000,
  <span class="token string">"upstreamtime"</span><span class="token keyword">:</span> <span class="token string">"-"</span>,
  <span class="token string">"upstreamhost"</span><span class="token keyword">:</span> <span class="token string">"-"</span>,
  <span class="token string">"http_host"</span><span class="token keyword">:</span> <span class="token string">"www.yanlinux.org"</span>,
  <span class="token string">"uri"</span><span class="token keyword">:</span> <span class="token string">"/echo"</span>,
  <span class="token string">"xff"</span><span class="token keyword">:</span> <span class="token string">"-"</span>,
  <span class="token string">"referer"</span><span class="token keyword">:</span> <span class="token string">"-"</span>,
  <span class="token string">"tcp_xff"</span><span class="token keyword">:</span> <span class="token string">"-"</span>,
  <span class="token string">"http_user_agent"</span><span class="token keyword">:</span> <span class="token string">"curl/7.61.1"</span>,
  <span class="token string">"status"</span><span class="token keyword">:</span> <span class="token string">"200"</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="6-5-启用缓存功能"><a href="#6-5-启用缓存功能" class="headerlink" title="6.5 启用缓存功能"></a>6.5 启用缓存功能</h3><h4 id="6-5-1-非缓存场景压力测试"><a href="#6-5-1-非缓存场景压力测试" class="headerlink" title="6.5.1 非缓存场景压力测试"></a>6.5.1 非缓存场景压力测试</h4><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#后端服务器准备</span>
<span class="token punctuation">[</span>17:03:54 root@rocky8 html<span class="token punctuation">]</span>$ <span class="token function">cat</span> /var/log/messages <span class="token operator">></span> m.html

<span class="token comment" spellcheck="true">#代理配置</span>
<span class="token punctuation">[</span>16:49:33 root@rocky conf.d<span class="token punctuation">]</span>$ <span class="token function">vi</span> pc.conf
server <span class="token punctuation">{</span>
    listen 443 ssl<span class="token punctuation">;</span>
    ssl_certificate /apps/nginx/ssl/www.yanlinux.org.crt<span class="token punctuation">;</span>
    ssl_certificate_key /apps/nginx/ssl/www.yanlinux.org.key<span class="token punctuation">;</span>
    ssl_session_cache shared:sslcache:20m<span class="token punctuation">;</span>
    ssl_session_timeout 10m<span class="token punctuation">;</span>
    server_name www.yanlinux.org<span class="token punctuation">;</span>
    root /apps/nginx/html/pc<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
server <span class="token punctuation">{</span>
    listen 80<span class="token punctuation">;</span>
    server_name www.yanlinux.org<span class="token punctuation">;</span>
    root /apps/nginx/html/pc<span class="token punctuation">;</span>
    access_log /apps/nginx/logs/www.yanlinux.org-access.log access_json<span class="token punctuation">;</span>
    location / <span class="token punctuation">{</span>                                                                                       
        proxy_pass http://10.0.0.28<span class="token punctuation">;</span>
        proxy_connect_timeout 10s<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">#客户端进行压力测试</span>
<span class="token punctuation">[</span>17:08:32 root@rocky8 ~<span class="token punctuation">]</span>$ ab -c 100 -n 2000 http://www.yanlinux.org/m.html
Server Software:        nginx/1.22.1
Server Hostname:        www.yanlinux.org
Server Port:            80

Document Path:          /m.html
Document Length:        605907 bytes

Concurrency Level:      100
Time taken <span class="token keyword">for</span> tests:   10.414 seconds
Complete requests:      2000
Failed requests:        0
Total transferred:      1212290000 bytes
HTML transferred:       1211814000 bytes
Requests per second:    192.05 <span class="token punctuation">[</span><span class="token comment" spellcheck="true">#/sec] (mean) #每秒请求数</span>
Time per request:       520.699 <span class="token punctuation">[</span>ms<span class="token punctuation">]</span> <span class="token punctuation">(</span>mean<span class="token punctuation">)</span>
Time per request:       5.207 <span class="token punctuation">[</span>ms<span class="token punctuation">]</span> <span class="token punctuation">(</span>mean, across all concurrent requests<span class="token punctuation">)</span>
Transfer rate:          113681.48 <span class="token punctuation">[</span>Kbytes/sec<span class="token punctuation">]</span> received<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="6-5-2-准备缓存配置"><a href="#6-5-2-准备缓存配置" class="headerlink" title="6.5.2 准备缓存配置"></a>6.5.2 准备缓存配置</h4><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#在主配置文件nginx.conf的http配置段加上下面一行信息，定义缓存</span>
<span class="token punctuation">[</span>17:12:06 root@rocky conf.d<span class="token punctuation">]</span>$ <span class="token function">vi</span> <span class="token punctuation">..</span>/nginx.conf
proxy_cache_path /data/nginx/proxycache levels<span class="token operator">=</span>1:2:2 keys_zone<span class="token operator">=</span>proxycache:20m inactive<span class="token operator">=</span>120s max_size
<span class="token operator">=</span>1g<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">#其中的/data/nginx/proxycache中的proxycache目录会自动生成</span>

<span class="token comment" spellcheck="true">#修改子配置文件</span>
server <span class="token punctuation">{</span>
    listen 443 ssl<span class="token punctuation">;</span>
    ssl_certificate /apps/nginx/ssl/www.yanlinux.org.crt<span class="token punctuation">;</span>
    ssl_certificate_key /apps/nginx/ssl/www.yanlinux.org.key<span class="token punctuation">;</span>
    ssl_session_cache shared:sslcache:20m<span class="token punctuation">;</span>
    ssl_session_timeout 10m<span class="token punctuation">;</span>
    server_name www.yanlinux.org<span class="token punctuation">;</span>
    root /apps/nginx/html/pc<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
server <span class="token punctuation">{</span>
    listen 80<span class="token punctuation">;</span>
    server_name www.yanlinux.org<span class="token punctuation">;</span>
    root /apps/nginx/html/pc<span class="token punctuation">;</span>
    access_log /apps/nginx/logs/www.yanlinux.org-access.log access_json<span class="token punctuation">;</span>
    location / <span class="token punctuation">{</span>
        proxy_pass http://10.0.0.28<span class="token punctuation">;</span>
        proxy_connect_timeout 10s<span class="token punctuation">;</span>
        proxy_cache proxycache<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">#启用缓存，缓存名跟上面定义的要一致</span>
        proxy_cache_key <span class="token variable">$request_uri</span><span class="token punctuation">;</span> 
        proxy_cache_valid any 5m<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">#必须指定哪些响应码的缓存，指定所有的响应码有效期五分钟</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">#自动生成缓存目录</span>
<span class="token punctuation">[</span>17:22:42 root@rocky conf.d<span class="token punctuation">]</span>$ ll /data/nginx/proxycache/
total 0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="6-5-3-访问并验证缓存文件"><a href="#6-5-3-访问并验证缓存文件" class="headerlink" title="6.5.3 访问并验证缓存文件"></a>6.5.3 访问并验证缓存文件</h4><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">[</span>17:09:39 root@rocky8 ~<span class="token punctuation">]</span>$ ab -c 100 -n 2000 http://www.yanlinux.org/m.html
Server Software:        nginx/1.22.1
Server Hostname:        www.yanlinux.org
Server Port:            80

Document Path:          /m.html
Document Length:        605907 bytes

Concurrency Level:      100
Time taken <span class="token keyword">for</span> tests:   5.465 seconds
Complete requests:      2000
Failed requests:        0
Total transferred:      1212290000 bytes
HTML transferred:       1211814000 bytes
Requests per second:    365.94 <span class="token punctuation">[</span><span class="token comment" spellcheck="true">#/sec] (mean) #性能提高将近一倍</span>
Time per request:       273.269 <span class="token punctuation">[</span>ms<span class="token punctuation">]</span> <span class="token punctuation">(</span>mean<span class="token punctuation">)</span>
Time per request:       2.733 <span class="token punctuation">[</span>ms<span class="token punctuation">]</span> <span class="token punctuation">(</span>mean, across all concurrent requests<span class="token punctuation">)</span>
Transfer rate:          216613.56 <span class="token punctuation">[</span>Kbytes/sec<span class="token punctuation">]</span> received

<span class="token comment" spellcheck="true">#验证缓存目录结构及文件大小</span>
<span class="token punctuation">[</span>17:23:03 root@rocky conf.d<span class="token punctuation">]</span>$ tree /data/nginx/proxycache/
/data/nginx/proxycache/
└── 7
    └── fd
        └── 7e
            └── 23dcf7c2b96327ee9899fc28a847efd7

3 directories, 1 <span class="token function">file</span>
<span class="token punctuation">[</span>17:26:02 root@rocky conf.d<span class="token punctuation">]</span>$ lh /data/nginx/proxycache/7/fd/7e/23dcf7c2b96327ee9899fc28a847efd7
-rw------- 1 nginx nginx 593K Nov  9 17:24 /data/nginx/proxycache/7/fd/7e/23dcf7c2b96327ee9899fc28a847efd7<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="7-使用脚本完成一键编译安装nginx任意版本。"><a href="#7-使用脚本完成一键编译安装nginx任意版本。" class="headerlink" title="7  使用脚本完成一键编译安装nginx任意版本。"></a>7  使用脚本完成一键编译安装nginx任意版本。</h2><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#一键安装脚本</span>
<span class="token punctuation">[</span>16:26:15 root@rocky8 ~<span class="token punctuation">]</span>$ <span class="token function">cat</span> install_nginx.sh 
<span class="token comment" spellcheck="true">#!/bin/bash</span>
<span class="token comment" spellcheck="true">#</span>
<span class="token comment" spellcheck="true">#***********************************************************</span>
<span class="token comment" spellcheck="true">#Author:            yanli</span>
<span class="token comment" spellcheck="true">#Date:              2022-11-01</span>
<span class="token comment" spellcheck="true">#FileName:          install_nginx.sh</span>
<span class="token comment" spellcheck="true">#Description:        </span>
<span class="token comment" spellcheck="true">#***********************************************************</span>

OS_TYPE<span class="token operator">=</span>`awk -F<span class="token string">'[ "]'</span> <span class="token string">'/^NAME/{print <span class="token variable">$2</span>}'</span> /etc/os-release<span class="token variable"><span class="token variable">`</span>
OS_VERSION<span class="token operator">=</span><span class="token variable">`</span></span><span class="token function">awk</span> -F<span class="token string">'[".]'</span> <span class="token string">'/^VERSION_ID/{print <span class="token variable">$2</span>}'</span> /etc/os-release<span class="token variable"><span class="token variable">`</span>
CPU<span class="token operator">=</span><span class="token variable">`</span></span>lscpu <span class="token operator">|</span><span class="token function">awk</span> <span class="token string">'/^CPU\(s\)/{print <span class="token variable">$2</span>}'</span>`
SRC_DIR<span class="token operator">=</span>/usr/local/src
<span class="token function">read</span> -p <span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token keyword">echo</span> -e '\033<span class="token punctuation">[</span>1<span class="token punctuation">;</span>32m请输入下载的版本号：\033<span class="token punctuation">[</span>0m'<span class="token variable">)</span></span>"</span> NUM
NGINX_FILE<span class="token operator">=</span>nginx-<span class="token variable">${NUM}</span>
NGINX_INSTALL_DIR<span class="token operator">=</span>/apps/nginx

color <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    RES_COL<span class="token operator">=</span>60
    MOVE_TO_COL<span class="token operator">=</span><span class="token string">"echo -en \\033[<span class="token variable">${RES_COL}</span>G"</span>
    SETCOLOR_SUCCESS<span class="token operator">=</span><span class="token string">"echo -en \\033[1;32m"</span>
    SETCOLOR_FAILURE<span class="token operator">=</span><span class="token string">"echo -en \\033[1;31m"</span>
    SETCOLOR_WARNING<span class="token operator">=</span><span class="token string">"echo -en \\033[1;33m"</span>
    SETCOLOR_NORMAL<span class="token operator">=</span><span class="token string">"echo -en \E[0m"</span>
    <span class="token keyword">echo</span> -n <span class="token string">"<span class="token variable">$1</span>"</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$MOVE_TO_COL</span>
    <span class="token keyword">echo</span> -n <span class="token string">"["</span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$2</span> <span class="token operator">=</span> <span class="token string">"success"</span> -o <span class="token variable">$2</span> <span class="token operator">=</span> <span class="token string">"0"</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span><span class="token keyword">then</span>
        <span class="token variable">${SETCOLOR_SUCCESS}</span>
        <span class="token keyword">echo</span> -n $<span class="token string">"  OK  "</span>
    <span class="token keyword">elif</span> <span class="token punctuation">[</span> <span class="token variable">$2</span> <span class="token operator">=</span> <span class="token string">"failure"</span> -o <span class="token variable">$2</span> <span class="token operator">=</span> <span class="token string">"1"</span>  <span class="token punctuation">]</span> <span class="token punctuation">;</span><span class="token keyword">then</span>
        <span class="token variable">${SETCOLOR_FAILURE}</span>
        <span class="token keyword">echo</span> -n $<span class="token string">"FAILED"</span>
    <span class="token keyword">else</span>
        <span class="token variable">${SETCOLOR_WARNING}</span>
        <span class="token keyword">echo</span> -n $<span class="token string">"WARNING"</span>
    <span class="token keyword">fi</span>
    <span class="token variable">${SETCOLOR_NORMAL}</span>
    <span class="token keyword">echo</span> -n <span class="token string">"]"</span>
    <span class="token keyword">echo</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">#下载源码</span>
wget_package<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token punctuation">[</span> -e <span class="token variable">${NGINX_INSTALL_DIR}</span> <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">{</span> color <span class="token string">"nginx 已安装,请卸载后再安装"</span> 1<span class="token punctuation">;</span> <span class="token keyword">exit</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token function">cd</span> <span class="token variable">${SRC_DIR}</span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span> -e <span class="token variable">${NGINX_FILE}</span>.tar.gz <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span>
        color <span class="token string">"源码包已经准备好"</span> 0
    <span class="token keyword">else</span>
        color <span class="token string">"开始下载源码包"</span> 0
        <span class="token function">wget</span> http://nginx.org/download/<span class="token variable">${NGINX_FILE}</span>.tar.gz
        <span class="token punctuation">[</span> <span class="token variable">$?</span> -ne 0 <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">{</span> color <span class="token string">"下载 <span class="token variable">${NGINX_FILE}</span>.tar.gz文件失败"</span> 1<span class="token punctuation">;</span> <span class="token keyword">exit</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">fi</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">#编译安装</span>
install_nginx<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    color <span class="token string">"开始安装nginx"</span> 0
    <span class="token keyword">if</span> <span class="token function">id</span> nginx <span class="token operator">&amp;</span><span class="token operator">></span> /dev/null<span class="token punctuation">;</span><span class="token keyword">then</span>
        color <span class="token string">"nginx用户已经存在"</span> 1
    <span class="token keyword">else</span>
        <span class="token function">useradd</span> -s /sbin/nologin -r nginx
        color <span class="token string">"nginx用户账号创建完成"</span> 0
    <span class="token keyword">fi</span>

    color <span class="token string">"开始安装nginx依赖包"</span> 0
    <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$OS_TYPE</span> <span class="token operator">==</span> <span class="token string">"Centos"</span> -a <span class="token variable">${OS_VERSION}</span> <span class="token operator">==</span> <span class="token string">'7'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span>
        yum -y <span class="token function">install</span> <span class="token function">make</span> gcc pcre-devel openssl-devel zlib-devel perl-ExtUtils-Embed
    <span class="token keyword">elif</span> <span class="token punctuation">[</span> <span class="token variable">$OS_TYPE</span> <span class="token operator">==</span> <span class="token string">"Centos"</span> -a <span class="token variable">${OS_VERSION}</span> <span class="token operator">==</span> <span class="token string">'8'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span>
        yum -y <span class="token function">install</span> <span class="token function">make</span> gcc-c++ libtool pcre pcre-devel zlib zlib-devel openssl openssl-devel perl-ExtUtils-Embed
    <span class="token keyword">elif</span> <span class="token punctuation">[</span> <span class="token variable">$OS_TYPE</span> <span class="token operator">==</span> <span class="token string">"Rocky"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span>
        yum -y <span class="token function">install</span> <span class="token function">make</span> gcc libtool pcre pcre-devel zlib zlib-devel openssl openssl-devel perl-ExtUtils-Embed
    <span class="token keyword">elif</span> <span class="token punctuation">[</span> <span class="token variable">$OS_TYPE</span> <span class="token operator">==</span> <span class="token string">"Ubuntu"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span>
        apt update
        apt -y <span class="token function">install</span> <span class="token function">make</span> gcc libpcre3 libpcre3-dev openssl libssl-dev zlib1g-dev 
    <span class="token keyword">else</span>
        color <span class="token string">'不支持此系统!'</span>  1
        <span class="token keyword">exit</span>
    <span class="token keyword">fi</span>

    <span class="token comment" spellcheck="true">#开始编译安装</span>
    color <span class="token string">"开始编译安装nginx"</span> 0
    <span class="token function">cd</span> <span class="token variable">$SRC_DIR</span>
    <span class="token function">tar</span> xf <span class="token variable">${NGINX_FILE}</span>.tar.gz
    <span class="token function">cd</span> <span class="token variable">${SRC_DIR}</span>/<span class="token variable">${NGINX_FILE}</span>
    ./configure --prefix<span class="token operator">=</span><span class="token variable">${NGINX_INSTALL_DIR}</span> --user<span class="token operator">=</span>nginx --group<span class="token operator">=</span>nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream --with-stream_ssl_module --with-stream_realip_module
    <span class="token function">make</span> -j <span class="token variable">${CPU}</span> <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> <span class="token function">install</span>
    <span class="token punctuation">[</span> <span class="token variable">$?</span> -eq 0 <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> color <span class="token string">"nginx 编译安装成功"</span> 0 <span class="token operator">||</span>  <span class="token punctuation">{</span> color <span class="token string">"nginx 编译安装失败,退出!"</span> 1 <span class="token punctuation">;</span><span class="token keyword">exit</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">echo</span> <span class="token string">"PATH=<span class="token variable">${NGINX_INSTALL_DIR}</span>/sbin:<span class="token variable">${PATH}</span>"</span> <span class="token operator">></span> /etc/profile.d/nginx.sh

    <span class="token comment" spellcheck="true">#创建service文件</span>
    <span class="token function">cat</span> <span class="token operator">></span> /lib/systemd/system/nginx.service <span class="token operator">&lt;&lt;</span><span class="token string">EOF
[Unit]
Description=The nginx HTTP and reverse proxy server
After=network.target remote-fs.target nss-lookup.target

[Service]
Type=forking
PIDFile=<span class="token variable">${NGINX_INSTALL_DIR}</span>/logs/nginx.pid
ExecStartPre=/bin/rm -f <span class="token variable">${NGINX_INSTALL_DIR}</span>/logs/nginx.pid
ExecStartPre=<span class="token variable">${NGINX_INSTALL_DIR}</span>/sbin/nginx -t
ExecStart=<span class="token variable">${NGINX_INSTALL_DIR}</span>/sbin/nginx
ExecReload=/bin/kill -s HUP \<span class="token variable">$MAINPID</span>
KillSignal=SIGQUIT
TimeoutStopSec=5
KillMode=process
PrivateTmp=true                                                                                        
LimitNOFILE=100000

[Install]
WantedBy=multi-user.target
EOF</span>

    <span class="token comment" spellcheck="true">#启动服务</span>
    systemctl <span class="token function">enable</span> --now nginx <span class="token operator">&amp;</span><span class="token operator">></span> /dev/null
    systemctl is-active nginx <span class="token operator">&amp;</span><span class="token operator">></span> /dev/null <span class="token operator">||</span>  <span class="token punctuation">{</span> color <span class="token string">"nginx 启动失败,退出!"</span> 1 <span class="token punctuation">;</span> <span class="token keyword">exit</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    color <span class="token string">"nginx 安装完成"</span> 0

<span class="token punctuation">}</span>

wget_package
install_nginx

<span class="token comment" spellcheck="true">#在rocky上执行</span>
<span class="token punctuation">[</span>16:18:19 root@rocky8 ~<span class="token punctuation">]</span>$ sh install_nginx.sh 
请输入下载的版本号：1.20.2
开始下载源码包                                             <span class="token punctuation">[</span>  OK  <span class="token punctuation">]</span>
--2022-11-01 16:18:54--  http://nginx.org/download/nginx-1.20.2.tar.gz
Resolving nginx.org <span class="token punctuation">(</span>nginx.org<span class="token punctuation">)</span><span class="token punctuation">..</span>. 52.58.199.22, 3.125.197.172, 2a05:d014:edb:5704::6, <span class="token punctuation">..</span>.
Connecting to nginx.org <span class="token punctuation">(</span>nginx.org<span class="token punctuation">)</span><span class="token operator">|</span>52.58.199.22<span class="token operator">|</span>:80<span class="token punctuation">..</span>. connected.
HTTP request sent, awaiting response<span class="token punctuation">..</span>. 302 Found
Location: http://183.207.33.36:9011/nginx.org/c3pr90ntc0td/download/nginx-1.20.2.tar.gz <span class="token punctuation">[</span>following<span class="token punctuation">]</span>
--2022-11-01 16:18:54--  http://183.207.33.36:9011/nginx.org/c3pr90ntc0td/download/nginx-1.20.2.tar.gz
Connecting to 183.207.33.36:9011<span class="token punctuation">..</span>. connected.
HTTP request sent, awaiting response<span class="token punctuation">..</span>. 200 OK
Length: 1062124 <span class="token punctuation">(</span>1.0M<span class="token punctuation">)</span> <span class="token punctuation">[</span>application/octet-stream<span class="token punctuation">]</span>
Saving to: ‘nginx-1.20.2.tar.gz’

nginx-1.20.2.tar.gz                                  100%<span class="token punctuation">[</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>

2022-11-01 16:18:56 <span class="token punctuation">(</span>684 KB/s<span class="token punctuation">)</span> - ‘nginx-1.20.2.tar.gz’ saved <span class="token punctuation">[</span>1062124/1062124<span class="token punctuation">]</span>

开始安装nginx                                              <span class="token punctuation">[</span>  OK  <span class="token punctuation">]</span>
nginx用户账号创建完成                                       <span class="token punctuation">[</span>  OK  <span class="token punctuation">]</span>
开始安装nginx依赖包                                         <span class="token punctuation">[</span>  OK  <span class="token punctuation">]</span>
Last metadata expiration check: 0:58:41 ago on Tue 01 Nov 2022 03:20:16 PM CST.
Package make-1:4.2.1-11.el8.x86_64 is already installed.
Package pcre-8.42-6.el8.x86_64 is already installed.
Package zlib-1.2.11-17.el8.x86_64 is already installed.
Package openssl-1:1.1.1k-4.el8.x86_64 is already installed.
Dependencies resolved.
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
 Package                                                  Architecture                        Version   
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
Installing:
 gcc                                                      x86_64                              8.5.0-10.1
 libtool                                                  x86_64                              2.4.6-25.e
 openssl-devel                                            x86_64                              1:1.1.1k-7
 pcre-devel                                               x86_64                              8.42-6.el8
 perl-ExtUtils-Embed                                      noarch                              1.34-421.e
 zlib-devel                                               x86_64                              1.2.11-19
 <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
 Complete<span class="token operator">!</span>
开始编译安装nginx                                    <span class="token punctuation">[</span>  OK  <span class="token punctuation">]</span>
checking <span class="token keyword">for</span> OS
 + Linux 4.18.0-348.el8.0.2.x86_64 x86_64
checking <span class="token keyword">for</span> C compiler <span class="token punctuation">..</span>. found
 + using GNU C compiler
 + gcc version: 8.5.0 20210514 <span class="token punctuation">(</span>Red Hat 8.5.0-10<span class="token punctuation">)</span> <span class="token punctuation">(</span>GCC<span class="token punctuation">)</span> 
checking <span class="token keyword">for</span> gcc -pipe switch <span class="token punctuation">..</span>. found
checking <span class="token keyword">for</span> -Wl,-E switch <span class="token punctuation">..</span>. found
checking <span class="token keyword">for</span> gcc <span class="token function">builtin</span> atomic operations <span class="token punctuation">..</span>. found
checking <span class="token keyword">for</span> C99 variadic macros <span class="token punctuation">..</span>. found
checking <span class="token keyword">for</span> gcc variadic macros <span class="token punctuation">..</span>. found
checking <span class="token keyword">for</span> gcc <span class="token function">builtin</span> 64 bit byteswap <span class="token punctuation">..</span>. found
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
<span class="token function">test</span> -d <span class="token string">'/apps/nginx/logs'</span> \
    <span class="token operator">||</span> <span class="token function">mkdir</span> -p <span class="token string">'/apps/nginx/logs'</span>
make<span class="token punctuation">[</span>1<span class="token punctuation">]</span>: Leaving directory <span class="token string">'/usr/local/src/nginx-1.20.2'</span>
nginx 编译安装成功                                         <span class="token punctuation">[</span>  OK  <span class="token punctuation">]</span>
nginx 安装完成                                            <span class="token punctuation">[</span>  OK  <span class="token punctuation">]</span>
<span class="token punctuation">[</span>16:24:30 root@rocky8 ~<span class="token punctuation">]</span>$ ss -ntl
State      Recv-Q      Send-Q           Local Address:Port           Peer Address:Port     Process     
LISTEN     0           128                    0.0.0.0:80                  0.0.0.0:*                    
LISTEN     0           128                    0.0.0.0:22                  0.0.0.0:*                    
LISTEN     0           128                       <span class="token punctuation">[</span>::<span class="token punctuation">]</span>:22                     <span class="token punctuation">[</span>::<span class="token punctuation">]</span>:*                    
<span class="token punctuation">[</span>16:24:53 root@rocky8 ~<span class="token punctuation">]</span>$ systemctl status nginx.service 
● nginx.service - The nginx HTTP and reverse proxy server
   Loaded: loaded <span class="token punctuation">(</span>/usr/lib/systemd/system/nginx.service<span class="token punctuation">;</span> enabled<span class="token punctuation">;</span> vendor preset: disabled<span class="token punctuation">)</span>
   Active: active <span class="token punctuation">(</span>running<span class="token punctuation">)</span> since Tue 2022-11-01 16:24:30 CST<span class="token punctuation">;</span> 33s ago
  Process: 16014 ExecStart<span class="token operator">=</span>/apps/nginx/sbin/nginx <span class="token punctuation">(</span>code<span class="token operator">=</span>exited, status<span class="token operator">=</span>0/SUCCESS<span class="token punctuation">)</span>
  Process: 16003 ExecStartPre<span class="token operator">=</span>/apps/nginx/sbin/nginx -t <span class="token punctuation">(</span>code<span class="token operator">=</span>exited, status<span class="token operator">=</span>0/SUCCESS<span class="token punctuation">)</span>
  Process: 15992 ExecStartPre<span class="token operator">=</span>/bin/rm -f /apps/nginx/logs/nginx.pid <span class="token punctuation">(</span>code<span class="token operator">=</span>exited, status<span class="token operator">=</span>0/SUCCESS<span class="token punctuation">)</span>
 Main PID: 16016 <span class="token punctuation">(</span>nginx<span class="token punctuation">)</span>
    Tasks: 2 <span class="token punctuation">(</span>limit: 11218<span class="token punctuation">)</span>
   Memory: 1.9M
   CGroup: /system.slice/nginx.service
           ├─16016 nginx: master process /apps/nginx/sbin/nginx
           └─16017 nginx: worker process

Nov 01 16:24:30 rocky8.yanlinux.cn systemd<span class="token punctuation">[</span>1<span class="token punctuation">]</span>: Starting The nginx HTTP and reverse proxy server<span class="token punctuation">..</span>.
Nov 01 16:24:30 rocky8.yanlinux.cn nginx<span class="token punctuation">[</span>16003<span class="token punctuation">]</span>: nginx: the configuration <span class="token function">file</span> /apps/nginx/conf/nginx.<span class="token operator">></span>
Nov 01 16:24:30 rocky8.yanlinux.cn nginx<span class="token punctuation">[</span>16003<span class="token punctuation">]</span>: nginx: configuration <span class="token function">file</span> /apps/nginx/conf/nginx.conf<span class="token operator">></span>
Nov 01 16:24:30 rocky8.yanlinux.cn systemd<span class="token punctuation">[</span>1<span class="token punctuation">]</span>: Started The nginx HTTP and reverse proxy server.

<span class="token comment" spellcheck="true">#Ubuntu上执行</span>
<span class="token punctuation">[</span>16:19:52 root@ubuntu2004 ~<span class="token punctuation">]</span>$ sh install_nginx.sh 
请输入下载的版本号：1.20.2
开始下载源码包                                             <span class="token punctuation">[</span>  OK  <span class="token punctuation">]</span>
--2022-11-01 16:20:02--  http://nginx.org/download/nginx-1.20.2.tar.gz
Resolving nginx.org <span class="token punctuation">(</span>nginx.org<span class="token punctuation">)</span><span class="token punctuation">..</span>. 3.125.197.172, 52.58.199.22, 2a05:d014:edb:5704::6, <span class="token punctuation">..</span>.
Connecting to nginx.org <span class="token punctuation">(</span>nginx.org<span class="token punctuation">)</span><span class="token operator">|</span>3.125.197.172<span class="token operator">|</span>:80<span class="token punctuation">..</span>. connected.
HTTP request sent, awaiting response<span class="token punctuation">..</span>. 200 OK
Length: 1062124 <span class="token punctuation">(</span>1.0M<span class="token punctuation">)</span> <span class="token punctuation">[</span>application/octet-stream<span class="token punctuation">]</span>
Saving to: ‘nginx-1.20.2.tar.gz’

nginx-1.20.2.tar.gz                                  100%<span class="token punctuation">[</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>

2022-11-01 16:20:05 <span class="token punctuation">(</span>657 KB/s<span class="token punctuation">)</span> - ‘nginx-1.20.2.tar.gz’ saved <span class="token punctuation">[</span>1062124/1062124<span class="token punctuation">]</span>

开始安装nginx                                              <span class="token punctuation">[</span>  OK  <span class="token punctuation">]</span>
nginx用户账号创建完成                                      <span class="token punctuation">[</span>  OK  <span class="token punctuation">]</span>
开始安装nginx依赖包                                   <span class="token punctuation">[</span>  OK  <span class="token punctuation">]</span>
Hit:1 https://mirrors.aliyun.com/ubuntu focal InRelease
Get:2 https://mirrors.aliyun.com/ubuntu focal-security InRelease <span class="token punctuation">[</span>114 kB<span class="token punctuation">]</span>
Get:3 https://mirrors.aliyun.com/ubuntu focal-updates InRelease <span class="token punctuation">[</span>114 kB<span class="token punctuation">]</span>
Get:4 https://mirrors.aliyun.com/ubuntu focal-backports InRelease <span class="token punctuation">[</span>108 kB<span class="token punctuation">]</span>
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
开始编译安装nginx                                     <span class="token punctuation">[</span>  OK  <span class="token punctuation">]</span>
checking <span class="token keyword">for</span> OS
 + Linux 5.4.0-125-generic x86_64
checking <span class="token keyword">for</span> C compiler <span class="token punctuation">..</span>. found
 + using GNU C compiler
 + gcc version: 9.4.0 <span class="token punctuation">(</span>Ubuntu 9.4.0-1ubuntu1~20.04.1<span class="token punctuation">)</span> 
checking <span class="token keyword">for</span> gcc -pipe switch <span class="token punctuation">..</span>. found
checking <span class="token keyword">for</span> -Wl,-E switch <span class="token punctuation">..</span>. found
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
<span class="token function">test</span> -d <span class="token string">'/apps/nginx/html'</span> \
    <span class="token operator">||</span> <span class="token function">cp</span> -R html <span class="token string">'/apps/nginx'</span>
<span class="token function">test</span> -d <span class="token string">'/apps/nginx/logs'</span> \
    <span class="token operator">||</span> <span class="token function">mkdir</span> -p <span class="token string">'/apps/nginx/logs'</span>
make<span class="token punctuation">[</span>1<span class="token punctuation">]</span>: Leaving directory <span class="token string">'/usr/local/src/nginx-1.20.2'</span>
nginx 编译安装成功                                         <span class="token punctuation">[</span>  OK  <span class="token punctuation">]</span>
nginx 安装完成                                         <span class="token punctuation">[</span>  OK  <span class="token punctuation">]</span>
<span class="token punctuation">[</span>16:30:37 root@ubuntu2004 ~<span class="token punctuation">]</span>$ ss -ntl
State      Recv-Q     Send-Q           Local Address:Port            Peer Address:Port     Process     
LISTEN     0          511                    0.0.0.0:80                   0.0.0.0:*                    
<span class="token punctuation">[</span>16:34:03 root@ubuntu2004 ~<span class="token punctuation">]</span>$ systemctl status nginx.service 
● nginx.service - The nginx HTTP and reverse proxy server
     Loaded: loaded <span class="token punctuation">(</span>/lib/systemd/system/nginx.service<span class="token punctuation">;</span> enabled<span class="token punctuation">;</span> vendor preset: enabled<span class="token punctuation">)</span>
     Active: active <span class="token punctuation">(</span>running<span class="token punctuation">)</span> since Tue 2022-11-01 16:30:37 CST<span class="token punctuation">;</span> 3min 44s ago
    Process: 9589 ExecStartPre<span class="token operator">=</span>/bin/rm -f /apps/nginx/logs/nginx.pid <span class="token punctuation">(</span>code<span class="token operator">=</span>exited, status<span class="token operator">=</span>0/SUCCESS<span class="token punctuation">)</span>
    Process: 9594 ExecStartPre<span class="token operator">=</span>/apps/nginx/sbin/nginx -t <span class="token punctuation">(</span>code<span class="token operator">=</span>exited, status<span class="token operator">=</span>0/SUCCESS<span class="token punctuation">)</span>
    Process: 9598 ExecStart<span class="token operator">=</span>/apps/nginx/sbin/nginx <span class="token punctuation">(</span>code<span class="token operator">=</span>exited, status<span class="token operator">=</span>0/SUCCESS<span class="token punctuation">)</span>
   Main PID: 9600 <span class="token punctuation">(</span>nginx<span class="token punctuation">)</span>
      Tasks: 2 <span class="token punctuation">(</span>limit: 2236<span class="token punctuation">)</span>
     Memory: 2.3M
     CGroup: /system.slice/nginx.service
             ├─9600 nginx: master process /apps/nginx/sbin/nginx
             └─9601 nginx: worker process

Nov 01 16:30:37 ubuntu2004 systemd<span class="token punctuation">[</span>1<span class="token punctuation">]</span>: Starting The nginx HTTP and reverse proxy server<span class="token punctuation">..</span>.
Nov 01 16:30:37 ubuntu2004 nginx<span class="token punctuation">[</span>9594<span class="token punctuation">]</span>: nginx: the configuration <span class="token function">file</span> /apps/nginx/conf/nginx.conf synt<span class="token operator">></span>
Nov 01 16:30:37 ubuntu2004 nginx<span class="token punctuation">[</span>9594<span class="token punctuation">]</span>: nginx: configuration <span class="token function">file</span> /apps/nginx/conf/nginx.conf <span class="token function">test</span> is <span class="token operator">></span>
Nov 01 16:30:37 ubuntu2004 systemd<span class="token punctuation">[</span>1<span class="token punctuation">]</span>: Started The nginx HTTP and reverse proxy server.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="8-任意编译一个第3方nginx模块，并使用。"><a href="#8-任意编译一个第3方nginx模块，并使用。" class="headerlink" title="8 任意编译一个第3方nginx模块，并使用。"></a>8 任意编译一个第3方nginx模块，并使用。</h2><h3 id="8-1-nginx-module-vts-模块实现流量监控"><a href="#8-1-nginx-module-vts-模块实现流量监控" class="headerlink" title="8.1 nginx-module-vts 模块实现流量监控"></a>8.1 nginx-module-vts 模块实现流量监控</h3><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#下载模块并解压</span>
<span class="token punctuation">[</span>15:40:18 root@rocky src<span class="token punctuation">]</span>$ <span class="token function">wget</span> https://github.com/vozlt/nginx-module-vts/archive/refs/tags/v0.2.1.tar.gz
<span class="token punctuation">[</span>15:40:26 root@rocky src<span class="token punctuation">]</span>$ <span class="token function">tar</span> xf v0.2.1.tar.gz 
<span class="token punctuation">[</span>15:40:31 root@rocky src<span class="token punctuation">]</span>$ ll
total 176
drwxr-xr-x 9 1001 1001    186 Nov  1 14:50 nginx-1.20.2
drwxrwxr-x 8 root root    165 Sep 17 04:42 nginx-module-vts-0.2.1

<span class="token comment" spellcheck="true">#查看安装nginx时的编译参数</span>
<span class="token punctuation">[</span>15:43:56 root@rocky nginx-1.22.1<span class="token punctuation">]</span>$ nginx -V
nginx version: nginx/1.22.1
built by gcc 8.5.0 20210514 <span class="token punctuation">(</span>Red Hat 8.5.0-10<span class="token punctuation">)</span> <span class="token punctuation">(</span>GCC<span class="token punctuation">)</span> 
built with OpenSSL 1.1.1k  FIPS 25 Mar 2021
TLS SNI support enabled
configure arguments: --prefix<span class="token operator">=</span>/apps/nginx --user<span class="token operator">=</span>nginx --group<span class="token operator">=</span>nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream --with-stream_ssl_module --with-stream_realip_module

<span class="token comment" spellcheck="true">#利用上面参数，并加上--add-module选项来将该模块编译进去</span>
<span class="token punctuation">[</span>15:45:18 root@rocky nginx-1.22.1<span class="token punctuation">]</span>$ ./configure --prefix<span class="token operator">=</span>/apps/nginx --user<span class="token operator">=</span>nginx --group<span class="token operator">=</span>nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream --with-stream_ssl_module --with-stream_realip_module --add-module<span class="token operator">=</span>/usr/local/src/nginx-module-vts-0.2.1
<span class="token punctuation">[</span>15:48:54 root@rocky nginx-1.22.1<span class="token punctuation">]</span>$ <span class="token function">make</span> -j 2 <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> <span class="token function">install</span>

<span class="token punctuation">[</span>15:49:07 root@rocky nginx-1.22.1<span class="token punctuation">]</span>$ ll /apps/nginx/sbin/
total 15580
-rwxr-xr-x 1 root root 8362544 Nov  7 15:48 nginx
-rwxr-xr-x 1 root root 7587592 Nov  2 10:26 nginx.old

<span class="token comment" spellcheck="true">#配置文件</span>
<span class="token punctuation">[</span>15:52:15 root@rocky ~<span class="token punctuation">]</span>$ <span class="token function">vi</span> /apps/nginx/conf/conf.d/pc.conf
vhost_traffic_status_zone<span class="token punctuation">;</span>
server <span class="token punctuation">{</span>
    server_name www.yanlinux.org<span class="token punctuation">;</span>
    root /apps/nginx/html/pc<span class="token punctuation">;</span>
    location /status <span class="token punctuation">{</span>
        vhost_traffic_status_display<span class="token punctuation">;</span>
        vhost_traffic_status_display_format html<span class="token punctuation">;</span>                                                      
    <span class="token punctuation">}</span>
    location <span class="token operator">=</span> /nginx_status <span class="token punctuation">{</span>
        stub_status<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">[</span>15:54:37 root@rocky ~<span class="token punctuation">]</span>$ systemctl restart nginx.service<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://yanlinuxblog.oss-cn-hangzhou.aliyuncs.com/img/image-20221107155551967.png" alt=""></p>
<h3 id="8-2-echo模块实现信息显示"><a href="#8-2-echo模块实现信息显示" class="headerlink" title="8.2 echo模块实现信息显示"></a>8.2 echo模块实现信息显示</h3><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#下载模块并解压</span>
<span class="token punctuation">[</span>16:00:09 root@rocky src<span class="token punctuation">]</span>$ <span class="token function">wget</span> https://github.com/openresty/echo-nginx-module/archive/refs/tags/v0.63.tar.gz
<span class="token punctuation">[</span>16:00:20 root@rocky src<span class="token punctuation">]</span>$ <span class="token function">tar</span> xf v0.63.tar.gz 
<span class="token punctuation">[</span>16:00:31 root@rocky src<span class="token punctuation">]</span>$ ll
total 232
drwxrwxr-x 5 root root    174 Aug  1 07:52 echo-nginx-module-0.63

<span class="token punctuation">[</span>16:00:59 root@rocky ~<span class="token punctuation">]</span>$ <span class="token function">cd</span> nginx-1.22.1/
<span class="token punctuation">[</span>16:01:34 root@rocky nginx-1.22.1<span class="token punctuation">]</span>$ ./configure --prefix<span class="token operator">=</span>/apps/nginx --user<span class="token operator">=</span>nginx --group<span class="token operator">=</span>nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream --with-stream_ssl_module --with-stream_realip_module --add-module<span class="token operator">=</span>/usr/local/src/nginx-module-vts-0.2.1 --add-module<span class="token operator">=</span>/usr/local/src/echo-nginx-module-0.63
<span class="token punctuation">[</span>16:02:49 root@rocky nginx-1.22.1<span class="token punctuation">]</span>$ <span class="token function">make</span> -j 2 <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> <span class="token function">install</span>
<span class="token punctuation">[</span>16:03:28 root@rocky nginx-1.22.1<span class="token punctuation">]</span>$ nginx -V
nginx version: nginx/1.22.1
built by gcc 8.5.0 20210514 <span class="token punctuation">(</span>Red Hat 8.5.0-10<span class="token punctuation">)</span> <span class="token punctuation">(</span>GCC<span class="token punctuation">)</span> 
built with OpenSSL 1.1.1k  FIPS 25 Mar 2021
TLS SNI support enabled
configure arguments: --prefix<span class="token operator">=</span>/apps/nginx --user<span class="token operator">=</span>nginx --group<span class="token operator">=</span>nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream --with-stream_ssl_module --with-stream_realip_module --add-module<span class="token operator">=</span>/usr/local/src/nginx-module-vts-0.2.1 --add-module<span class="token operator">=</span>/usr/local/src/echo-nginx-module-0.63

<span class="token punctuation">[</span>16:07:09 root@rocky ~<span class="token punctuation">]</span>$ <span class="token function">vi</span> /apps/nginx/conf/conf.d/pc.conf
vhost_traffic_status_zone<span class="token punctuation">;</span>
server <span class="token punctuation">{</span>
    server_name www.yanlinux.org<span class="token punctuation">;</span>
    root /apps/nginx/html/pc<span class="token punctuation">;</span>
    location /status <span class="token punctuation">{</span>
        vhost_traffic_status_display<span class="token punctuation">;</span>
        vhost_traffic_status_display_format html<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    location <span class="token operator">=</span> /nginx_status <span class="token punctuation">{</span>
        stub_status<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    location /echo <span class="token punctuation">{</span>
        <span class="token keyword">echo</span> <span class="token string">"hello yanli"</span><span class="token punctuation">;</span>
        <span class="token keyword">echo</span> <span class="token variable">$remote_addr</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">#打印远程主机的ip</span>
        <span class="token keyword">echo</span> <span class="token variable">$uri</span>          <span class="token comment" spellcheck="true">#打印uri                                                                             </span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">[</span>16:08:28 root@rocky ~<span class="token punctuation">]</span>$ systemctl restart nginx.service


<span class="token comment" spellcheck="true">#测试</span>
<span class="token punctuation">[</span>15:15:40 root@rocky8 ~<span class="token punctuation">]</span>$ curl www.yanlinux.org/echo
hello yanli
10.0.0.18
/echo<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            </div>
            <hr/>

            
            <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.88rem;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-large waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fa fa-close"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力!</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="https://yanlinuxblog.oss-cn-hangzhou.aliyuncs.com/img/202207291304818.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="https://yanlinuxblog.oss-cn-hangzhou.aliyuncs.com/img/202207292224344.jpg" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>
            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    <div class="social-share" data-disabled="qzone" data-wechat-qrcode-helper="<p>微信里点“发现”->“扫一扫”二维码便可查看分享。</p>"></div>
    
</div>

<script src="/libs/share/js/social-share.min.js"></script>

            
            
            
            <div class="reprint1">
                <p>
                    <span class="reprint1-tip">
                        <i class="fa fa-exclamation-circle"></i>&nbsp;&nbsp;转载请注明:
                    </span>
                    <a href="http://www.yanlinux.cn" class="b-link-green">焱黎的博客</a>
                    <i class="fa fa-angle-right fa-lg fa-fw text-color"></i>
                    <a href="/clch64x6m003a0sak6syoe1h3/" class="b-link-green">第八周作业</a>
                </p>
            </div>

        </div>
    </div>

    

    

    

    
    <div class="livere-card card" data-aos="fade-up">
    <!-- 来必力City版安装代码 -->
    <div id="lv-container" class="card-content" data-id="city" data-uid="MTAyMC81Njg5OC8zMzM2Mg==">
        <script type="text/javascript">
            (function (d, s) {
                let j, e = d.getElementsByTagName(s)[0];
                if (typeof LivereTower === 'function') {
                    return;
                }

                j = d.createElement(s);
                j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
                j.async = true;

                e.parentNode.insertBefore(j, e);
            })(document, 'script');
        </script>
        <noscript>为正常使用来必力评论功能请激活JavaScript。</noscript>
    </div>
    <!-- City版安装代码已完成 -->
</div>
    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/clch64x6n003b0sak3ry90lyr/">
                    <div class="card-image">
                        
                        <img src="https://yanlinuxblog.oss-cn-hangzhou.aliyuncs.com/img/img-7.jpg" class="responsive-img" alt="第九周作业">
                        
                        <span class="card-title">第九周作业</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            每周都进步一点点！
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2022-11-18
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/作业/" class="post-category" target="_blank">
                                    作业
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/jumpserver/" target="_blank">
                        <span class="chip bg-color">jumpserver</span>
                    </a>
                    
                    <a href="/tags/nginx-rewrite/" target="_blank">
                        <span class="chip bg-color">nginx rewrite</span>
                    </a>
                    
                    <a href="/tags/nginx动静分离/" target="_blank">
                        <span class="chip bg-color">nginx动静分离</span>
                    </a>
                    
                    <a href="/tags/nginx防盗链/" target="_blank">
                        <span class="chip bg-color">nginx防盗链</span>
                    </a>
                    
                    <a href="/tags/nginx负载均衡算法/" target="_blank">
                        <span class="chip bg-color">nginx负载均衡算法</span>
                    </a>
                    
                    <a href="/tags/LNMP搭建/" target="_blank">
                        <span class="chip bg-color">LNMP搭建</span>
                    </a>
                    
                    <a href="/tags/tomcat应用发布/" target="_blank">
                        <span class="chip bg-color">tomcat应用发布</span>
                    </a>
                    
                    <a href="/tags/tomcat-session粘滞/" target="_blank">
                        <span class="chip bg-color">tomcat session粘滞</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/clch64x5w000q0sakv2jym27t/">
                    <div class="card-image">
                        
                        <img src="https://yanlinuxblog.oss-cn-hangzhou.aliyuncs.com/img/6.jpg" class="responsive-img" alt="第七周作业">
                        
                        <span class="card-title">第七周作业</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            fighting!
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2022-10-26
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/作业/" class="post-category" target="_blank">
                                    作业
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/redis/" target="_blank">
                        <span class="chip bg-color">redis</span>
                    </a>
                    
                    <a href="/tags/Postgresql/" target="_blank">
                        <span class="chip bg-color">Postgresql</span>
                    </a>
                    
                    <a href="/tags/高可用LAMP搭建/" target="_blank">
                        <span class="chip bg-color">高可用LAMP搭建</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>
</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('30')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'pre') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: 焱黎的博客<br />'
            + '作者: 焱黎<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>
<!-- 代码语言 -->
<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>
<!-- 代码块复制 -->
<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>
<script type="text/javascript" src="/libs/codeBlock/clipboard.min.js"></script>
<!-- 代码块收缩 -->
<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script> 
<!-- 代码块折行 -->
<style type="text/css">code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }</style>

    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fa fa-list"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4, h5'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4, h5').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).slideUp(500);
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).slideDown(500);
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>
    

</main>


        <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="col s12 m8 l8 copy-right">
            Copyright&copy; 2022 焱黎. 

            <br>
            <span id="sitetime"></span><span class="my-face">ღゝ◡╹)ノ♡</span>
            <br>

            

            
                    
                        <span id="busuanzi_container_site_pv" style='display:none'></span>
                        总访问量: <span id="busuanzi_value_site_pv" class="white-color"></span>
                    
        
                    
                        <span id="busuanzi_container_site_uv" style='display:none'></span>
                        人次&nbsp; | &nbsp;访客人数: <span id="busuanzi_value_site_uv" class="white-color"></span> 人
                    
    
            

            
                &nbsp; | &nbsp;字数统计:&nbsp;
                <span class="white-color">262.3k</span> 字
            

            
            <br>

        </div>

        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/yanlinux" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>


 
    <a href="https://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&email=lgq6579@163.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fa fa-envelope-open"></i>
    </a>






    <a href="http://wpa.qq.com/msgrd?v=3&uin=1499214187&site=qq&menu=yes" class="tooltipped" target="_blank" data-tooltip="访问我的QQ空间" data-position="top" data-delay="50">
        <i class="fa fa-qq"></i>
    </a>





    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fa fa-rss"></i>
    </a>
</div>

    </div>
</footer>

<div class="progress-bar"></div>

<script language=javascript>
    function siteTime() {
        window.setTimeout("siteTime()", 1000);
        var seconds = 1000;
        var minutes = seconds * 60;
        var hours = minutes * 60;
        var days = hours * 24;
        var years = days * 365;
        var today = new Date();
        var todayYear = today.getFullYear();
        var todayMonth = today.getMonth() + 1;
        var todayDate = today.getDate();
        var todayHour = today.getHours();
        var todayMinute = today.getMinutes();
        var todaySecond = today.getSeconds();

        /* Date.UTC() -- 返回date对象距世界标准时间(UTC)1970年1月1日午夜之间的毫秒数(时间戳)
        year - 作为date对象的年份，为4位年份值
        month - 0-11之间的整数，做为date对象的月份
        day - 1-31之间的整数，做为date对象的天数
        hours - 0(午夜24点)-23之间的整数，做为date对象的小时数
        minutes - 0-59之间的整数，做为date对象的分钟数
        seconds - 0-59之间的整数，做为date对象的秒数
        microseconds - 0-999之间的整数，做为date对象的毫秒数 */

        var t1 = Date.UTC(2022, 07, 25, 00, 00, 00); //北京时间2022-7-25 00:00:00
        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
        var diff = t2 - t1;
        var diffYears = Math.floor(diff / years);
        var diffDays = Math.floor((diff / days) - diffYears * 365);
        var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
        var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) / minutes);
        var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours - diffMinutes *
            minutes) / seconds);
        document.getElementById("sitetime").innerHTML = "本站已勉强运行 " + diffYears + " 年 " + diffDays + " 天 " + diffHours +
            " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒" ;
    } /*因为建站时间还没有一年，就将之注释掉了。需要的可以取消*/
    siteTime();
</script>






        <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
        <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


        <script src="https://cdn.bootcss.com/materialize/1.0.0/js/materialize.min.js"></script>
        <script src="https://cdn.bootcss.com/masonry/4.2.2/masonry.pkgd.min.js"></script>
        <script src="https://cdn.bootcss.com/aos/3.0.0-beta.6/aos.js"></script>
        <script src="https://cdn.bootcss.com/scrollprogress/3.0.2/scrollProgress.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/1.7.2/js/lightgallery-all.min.js"></script>
        <script src="/js/matery.js"></script>

        <!-- Global site tag (gtag.js) - Google Analytics -->



        
            <script src="/libs/others/clicklove.js"></script>
        

        
            <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
        

        <!-- 洪卫 shw2018 add 2019.08.28 -->
        <script type="text/javascript">
            var OriginTitile = document.title,
                st;
            document.addEventListener("visibilitychange", function () {
                document.hidden ? (document.title = "看不见我🙈~看不见我🙈~", clearTimeout(st)) : (document.title =
                    "(๑•̀ㅂ•́) ✧被发现了～", st = setTimeout(function () {
                        document.title = OriginTitile
                    }, 3e3))
            })
        </script>

        <!-- 鼠标点击烟花爆炸效果  洪卫 shw2018 add 2019.09.09 -->
        

        <!-- 背景雪花飘落特效洪卫 shw2018 add 2019.09.10 -->
        
            <script type="text/javascript">
            //只在桌面版网页启用特效
            var windowWidth = $(window).width();
            if (windowWidth > 768) {
                document.write('<script type="text/javascript" src="/js/sakura.js"><\/script>');
            }
            </script>
        

        <!-- 鼠标点击文字特效 洪卫 shw2018 add 2019.09.10-->
        
            <script src="/js/wenzi.js" type="text/javascript"></script>
        

        <!-- 背景雪花飘落特效 洪卫 shw2018 add 2019.09.10 -->
        

        <!-- 在线聊天工具  洪卫 shw2018 add 2019.09.11 -->
        

        <!-- 背景 canvas-nest  洪卫 shw 2018  add 2019.09.15-->
        
            <script type="text/javascript">
            var windowWidth = $(window).width();
            if (windowWidth > 992) {
                document.write('<script type="text/javascript" color="0,0,255" pointColor="0,0,255" opacity= "0.8" zIndex="--1" count="150"src="/libs/background/canvas-nest.js"><\/script>');
            }
            </script>
        

        <!-- 背景静止彩带  洪卫 shw 2018  add 2019.09.15-->
        

        <!-- 背景动态彩带 洪卫 shw 2018  add 2019.09.15-->
        
            <script type="text/javascript">
            var windowWidth = $(window).width();
            if (windowWidth > 992) {
                document.write('<script type="text/javascript" src="/libs/background/ribbon-dynamic.js"><\/script>');
            }
            </script>
        

    <script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"position":"left","width":150,"height":200},"mobile":{"show":false},"react":{"opacity":0.7}});</script><!-- hexo-inject:begin --><!-- hexo-inject:end --></body>
</html>